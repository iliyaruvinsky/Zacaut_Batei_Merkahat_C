# Chunker Output - Instructions for Documenter

**Generated by:** CIDRA Chunker Agent (CH)
**Task ID:** CH-FATHER-001
**Date:** 2026-02-02
**Status:** COMPLETE

---

## Run Information

| Metric | Value |
|--------|-------|
| Component | FatherProcess |
| Chunks Created | 13 |
| Total Lines | 2144 |
| Total Files | 4 |
| Language | C |
| Strategy | Function-level with main() sub-chunking |

---

## Key Findings

### System Role
- **FatherProcess is the watchdog/supervisor daemon** that initializes and monitors the entire MACCABI healthcare system
- Registers as `FATHERPROC_TYPE` for both `PHARM_SYS | DOCTOR_SYS` subsystems
- Written by Ely Levy (Reshuma), 30.05.1996

### Boot Sequence (Critical Path)
1. `SQLMD_connect()` retry loop until `MAIN_DB->Connected`
2. `CreateSemaphore()` - system semaphore
3. `InitFirstExtent(SharedSize)` - shared memory initialization
4. `CreateTable` loop over `TableTab[]` - creates all shared memory tables
5. `AddCurrProc()` - registers self in process table
6. `run_system()` - starts all child processes

### IPC Architecture
- **Named pipes** are actually Unix-domain sockets (`AF_UNIX`, `SOCK_STREAM`)
- Uses `GetSocketMessage()` for IPC command reception
- Control commands: `LOAD_PAR`, `STRT_PH_ONLY`, `STRT_DC_ONLY`, `STDN_PH_ONLY`, `STDN_DC_ONLY`, `SHUT_DWN`, `STDN_IMM`

### Multi-Instance Support
- `TInstanceControl` array manages programs that need multiple instances
- Fields: `program_type`, `instance_control`, `startup_instances`, `max_instances`, `min_free_instances`
- Watchdog loop monitors and starts new instances as needed

### Graceful Shutdown
- SIGTERM triggers `TerminateHandler()` which sets `caught_signal`
- Sends SIGTERM (soft kill) to: SqlServer, As400UnixServer, DocSqlServer, PurchaseHistoryServer
- Sends Signal 9 (hard kill) to all other processes
- 1-second delay before `DeleteSemaphore()` to avoid race conditions

---

## Chunk Index

### Global Declarations
| Chunk ID | Lines | Summary |
|----------|-------|---------|
| ch_father_001_globals | 1-145 | File header, defines, TABLE pointers, globals |

### main() Function (Sub-chunked)
| Chunk ID | Lines | Summary |
|----------|-------|---------|
| ch_father_002_main_init | 146-351 | Initialization: fcntl, setsid, signals, DB connect, semaphore, shared memory, tables |
| ch_father_003_main_stats_startup | 352-471 | Statistics setup (tstt/dstt), MAC_SYS env parsing, run_system() call |
| ch_father_004_main_watchdog_status | 453-661 | Watchdog loop: system state machine, process counting |
| ch_father_005_main_watchdog_deadchild | 662-1103 | Watchdog loop: dead child detection, waitpid, restart logic |
| ch_father_006_main_watchdog_ipc | 1104-1321 | Watchdog loop: IPC messages, multi-instance control |
| ch_father_007_main_shutdown | 1322-1469 | Shutdown: kill children, cleanup resources |

### Helper Functions
| Chunk ID | Lines | Function | Summary |
|----------|-------|----------|---------|
| ch_father_008_sql_dbparam | 1473-1597 | sql_dbparam_into_shm | Load params from DB to shared memory |
| ch_father_009_sqlgetparams | 1601-1757 | SqlGetParamsByName | Get params by program name, fill InstanceControl |
| ch_father_010_run_system | 1761-1884 | run_system | Start child processes from params table |
| ch_father_011_getprogparm | 1888-1926 | GetProgParm | Lookup single parameter from shared memory |
| ch_father_012_terminate_handler | 1930-1972 | TerminateHandler | Signal handler for SIGTERM/SIGFPE/SIGSEGV |

### ODBC Operators
| Chunk ID | Lines | File | Summary |
|----------|-------|------|---------|
| ch_father_013_odbc_operators | 1-115 | MacODBC_MyOperators.c | SQL cursor definitions for setup_new table |

---

## Recommended Documentation Order

1. **Start with initialization** (ch_father_001, ch_father_002)
   - Understand globals, boot sequence, resource creation

2. **Document the watchdog loop** (ch_father_003 through ch_father_006)
   - State machine, process monitoring, IPC commands

3. **Document helper functions** (ch_father_008 through ch_father_011)
   - Database integration, parameter handling

4. **Document shutdown** (ch_father_007, ch_father_012)
   - Graceful termination, signal handling

5. **Document ODBC layer** (ch_father_013)
   - SQL cursors and setup_new table access

---

## Cross-References

### External Dependencies (must document interactions)

| Library | Key Functions | Purpose |
|---------|---------------|---------|
| GenLib | `InitFirstExtent`, `CreateTable`, `Run_server`, `AddCurrProc` | Shared memory, process spawn |
| GenLib | `ListenSocketNamed`, `GetSocketMessage`, `DisposeSockets` | Named socket IPC |
| GenLib | `CreateSemaphore`, `DeleteSemaphore` | System semaphore |
| GenSql | `SQLMD_connect`, `SQLMD_disconnect`, cursors | Database access |
| GenSql | `TableTab[]` | Shared memory table schema |

### Shared Memory Tables Used
- `PARM_TABLE` (parm_tablep) - Parameters from setup_new
- `PROC_TABLE` (proc_tablep) - Process registry
- `STAT_TABLE` (stat_tablep) - System status
- `UPDT_TABLE` (updt_tablep) - Table update timestamps
- `TSTT_TABLE` (tstt_tablep) - Pharmacy statistics
- `DSTT_TABLE` (dstt_tablep) - Doctor statistics
- `DIPR_TABLE` (dipr_tablep) - Died processes

### Related Components
- **SqlServer** - Child process, receives SIGTERM on shutdown
- **As400UnixServer** - Child process, receives SIGTERM on shutdown
- **GenLib/Memory.c** - Implements `Run_server()` and `InitSonProcess()`
- **GenSql/GenSql.c** - Defines `TableTab[]` schema

---

## Warnings and Notes

### Security Considerations
- Credentials (MacUser, MacPass, MacDb) are stored in shared memory
- Document their flow but **do not copy actual values**
- Check `RESEARCH/context_summary.md` for redacted secrets locations

### Anti-Hallucination
- All line numbers have been verified against actual source
- Function boundaries have been confirmed by reading the code
- Do NOT invent functions or features not present in the chunks

### Legacy Code Notes
- X.25 code (TSX25WORKPROC_TYPE) is obsolete but still present
- PharmTcpWorker.exe and DocTcpWorker.exe no longer exist
- Statistics tables (tstt/dstt) are "not in real use anymore" per code comments

---

## Files Reference

```
CHUNKS/FatherProcess/
├── repository.json           # All 13 chunks with full metadata
├── graph.json                # Dependency and call relationships
├── analysis.json             # Codebase statistics and findings
├── run_manifest.json         # Execution metadata (this run)
└── DOCUMENTER_INSTRUCTIONS.md # This file
```

---

## Next Steps for Documenter

1. Read `repository.json` to access chunk content and metadata
2. Read `graph.json` to understand relationships
3. Read `analysis.json` for statistics and key findings
4. Follow the recommended documentation order above
5. Generate 7-file documentation set per CIDRA standards
6. Achieve 100/100 validation score

---

*Generated by CIDRA Chunker Agent*
*Task CH-FATHER-001 COMPLETE*
