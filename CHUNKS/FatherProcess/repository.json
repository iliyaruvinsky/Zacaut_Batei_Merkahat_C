{
  "metadata": {
    "project": "Zacaut_Batei_Merkahat_C",
    "component": "FatherProcess",
    "chunked_at": "2026-02-02T12:00:00Z",
    "total_chunks": 13,
    "total_lines": 2144,
    "total_files": 4,
    "language": "C",
    "agent": "CIDRA Chunker v1.0.0",
    "task_id": "CH-FATHER-001"
  },
  "chunks": [
    {
      "chunk_id": "ch_father_001_globals",
      "file": "FatherProcess.c",
      "type": "global_declarations",
      "section": "file_header_and_globals",
      "line_start": 1,
      "line_end": 145,
      "tokens": 1200,
      "summary": "File header, preprocessor defines, global TABLE pointers (parm_tablep, proc_tablep, stat_tablep, etc.), table_ptrs array mapping, InstanceControl array, and function prototypes. Establishes the shared-memory table infrastructure.",
      "tags": ["initialization", "globals", "shared_memory", "table_pointers", "defines"],
      "dependencies": ["MacODBC.h", "MsgHndlr.h"],
      "defines": ["MAIN", "FATHER", "NO_PRN", "prn", "prn_1", "prn_2", "Conflict_Test", "PROG_KEY_LEN", "PARAM_NAM_LEN", "PARAM_VAL_LEN"],
      "globals": ["parm_tablep", "proc_tablep", "updt_tablep", "stat_tablep", "tstt_tablep", "dstt_tablep", "prsc_tablep", "msg_recid_tablep", "dipr_tablep", "table_ptrs", "InstanceControl", "running_system", "caught_signal", "TikrotProductionMode", "UseODBC", "sig_act_terminate"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_father_002_main_init",
      "file": "FatherProcess.c",
      "type": "function_section",
      "function": "main",
      "section": "initialization",
      "line_start": 146,
      "line_end": 351,
      "tokens": 2800,
      "summary": "main() initialization section: local variable declarations, file descriptor setup (fcntl), session leader (setsid), environment init/hash (InitEnv/HashEnv), SIGTERM handler installation via sigaction, SQLMD_connect retry loop until MAIN_DB->Connected, SqlGetParamsByName for FatherParams, memory locking (mlockall/plock), setuid to unprivileged user, named pipe creation (GetCurrNamedPipe/ListenSocketNamed), CreateSemaphore, InitFirstExtent for shared memory, CreateTable loop over TableTab[] with refresh functions, AddCurrProc to register as FATHERPROC_TYPE.",
      "tags": ["initialization", "main", "database_connect", "semaphore", "shared_memory", "signal_handler", "SIGTERM"],
      "dependencies": ["InitEnv", "HashEnv", "SQLMD_connect", "SqlGetParamsByName", "GetCurrNamedPipe", "ListenSocketNamed", "CreateSemaphore", "InitFirstExtent", "CreateTable", "AddCurrProc"],
      "calls": ["fcntl", "setsid", "InitEnv", "HashEnv", "GetCurrProgName", "memset", "sigaction", "SQLMD_connect", "sleep", "GerrLogMini", "SqlGetParamsByName", "mlockall", "plock", "setuid", "atoi", "GetCurrNamedPipe", "ListenSocketNamed", "CreateSemaphore", "InitFirstExtent", "CreateTable", "GetDate", "GetTime", "AddItem", "sql_dbparam_into_shm", "AddCurrProc"],
      "key_patterns": {
        "boot_sequence": "CreateSemaphore -> InitFirstExtent -> CreateTable loop -> AddCurrProc",
        "db_retry_loop": "SQLMD_connect with sleep(10) until MAIN_DB->Connected"
      },
      "complexity": "high"
    },
    {
      "chunk_id": "ch_father_003_main_stats_startup",
      "file": "FatherProcess.c",
      "type": "function_section",
      "function": "main",
      "section": "statistics_and_system_startup",
      "line_start": 352,
      "line_end": 471,
      "tokens": 1800,
      "summary": "Creates and initializes pharmacy statistics (tstt_data) and doctor statistics (dstt_data) rows in shared memory. Determines running_system bitmap from MAC_SYS environment variable (PHARM_SYS, DOCTOR_SYS, DOCTOR_SYS_TCP). Calls run_system() to start all child processes.",
      "tags": ["statistics", "startup", "environment", "run_system", "subsystems"],
      "dependencies": ["AddItem", "run_system", "getenv"],
      "calls": ["bzero", "time", "AddItem", "getenv", "strstr", "GerrLogMini", "run_system"],
      "data_structures": ["TSTT_DATA", "DSTT_DATA"],
      "system_flags": ["PHARM_SYS", "DOCTOR_SYS", "DOCTOR_SYS_TCP"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_father_004_main_watchdog_status",
      "file": "FatherProcess.c",
      "type": "function_section",
      "function": "main",
      "section": "watchdog_loop_system_status",
      "line_start": 453,
      "line_end": 661,
      "tokens": 2600,
      "summary": "Main watchdog loop entry and system status management. Monitors system state via GetSonsCount and get_sys_status. Handles state machine for whole system (GOING_UP->SYSTEM_UP->GOING_DOWN->SYSTEM_DOWN) and per-subsystem (pharm_status, doctor_status). Counts running pharmacy/doctor child processes by iterating proc_tablep.",
      "tags": ["watchdog", "monitoring", "state_machine", "system_status", "process_counting"],
      "dependencies": ["GetSonsCount", "get_sys_status", "set_sys_status", "RewindTable", "ActItems"],
      "calls": ["GetSonsCount", "get_sys_status", "set_sys_status", "RewindTable", "ActItems", "ListTables", "time", "GerrLogMini"],
      "state_values": ["GOING_UP", "SYSTEM_UP", "GOING_DOWN", "SYSTEM_DOWN"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_father_005_main_watchdog_deadchild",
      "file": "FatherProcess.c",
      "type": "function_section",
      "function": "main",
      "section": "watchdog_loop_dead_children",
      "line_start": 662,
      "line_end": 1103,
      "tokens": 5500,
      "summary": "Handles detection and processing of dead/stopped child processes. Uses waitpid(WNOHANG) to check for terminated children. Falls back to dipr_tablep (died-processes table) if waitpid returns 0. Checks for orphan processes via getpgid during system shutdown. Logs death details with elapsed time calculation. Processes exit status (WIFEXITED, WIFSTOPPED, WIFSIGNALED) with detailed switch on exit codes (MAC_SERV_SHUT_DOWN, MAC_EXIT_NO_MEM, MAC_EXIT_SIGNAL, etc.). Restarts child processes via Run_server() based on retry limits and system state.",
      "tags": ["watchdog", "process_death", "waitpid", "restart", "error_handling", "child_process"],
      "dependencies": ["waitpid", "ActItems", "DeleteItem", "Run_server", "getpgid"],
      "calls": ["waitpid", "ActItems", "GetItem", "DeleteItem", "time", "localtime", "AddToSonsCount", "GetProc", "access", "unlink", "sprintf", "get_sys_status", "Run_server", "GerrLogMini", "getpgid"],
      "exit_codes": ["MAC_SERV_SHUT_DOWN", "MAC_SYST_SHUT_DOWN", "MAC_EXIT_NO_MEM", "MAC_EXIT_SQL_ERR", "MAC_EXIT_SQL_CONNECT", "MAC_EXIT_SELECT", "MAC_EXIT_TCP", "MAC_EXIT_SIGNAL", "MAC_CHILD_NOT_STARTED", "MAC_SERV_RESET"],
      "data_structures": ["PROC_DATA", "DIPR_DATA"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_father_006_main_watchdog_ipc",
      "file": "FatherProcess.c",
      "type": "function_section",
      "function": "main",
      "section": "watchdog_loop_ipc_messages",
      "line_start": 1104,
      "line_end": 1321,
      "tokens": 2800,
      "summary": "Handles IPC messages from children/PC controller via GetSocketMessage. Processes control commands: LOAD_PAR (reload parameters), STRT_PH_ONLY/STRT_DC_ONLY (start subsystems), STDN_PH_ONLY/STDN_DC_ONLY (shutdown subsystems), SHUT_DWN (graceful shutdown), STDN_IMM (immediate shutdown). Also manages multi-instance child programs via InstanceControl array - monitors running/available instances and starts new ones as needed.",
      "tags": ["watchdog", "ipc", "socket_messages", "control_commands", "multi_instance", "instance_control"],
      "dependencies": ["GetSocketMessage", "SqlGetParamsByName", "sql_dbparam_into_shm", "run_system", "set_sys_status", "Run_server"],
      "calls": ["GetSocketMessage", "ListNMatch", "GerrLogMini", "SqlGetParamsByName", "sql_dbparam_into_shm", "get_sys_status", "run_system", "set_sys_status", "RewindTable", "ActItems", "Run_server"],
      "ipc_commands": ["LOAD_PAR", "STRT_PH_ONLY", "STRT_DC_ONLY", "STDN_PH_ONLY", "STDN_DC_ONLY", "SHUT_DWN", "STDN_IMM"],
      "data_structures": ["TInstanceControl", "PROC_DATA"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_father_007_main_shutdown",
      "file": "FatherProcess.c",
      "type": "function_section",
      "function": "main",
      "section": "shutdown_sequence",
      "line_start": 1322,
      "line_end": 1469,
      "tokens": 2000,
      "summary": "System shutdown sequence after exiting watchdog loop. Iterates through proc_tablep to terminate all child processes. Sends SIGTERM (soft kill) to SqlServer, As400UnixServer, DocSqlServer, PurchaseHistoryServer; Signal 9 (hard kill) to others. Removes named pipes. Disconnects from database (SQLMD_disconnect), closes sockets (DisposeSockets), removes shared memory (KillAllExtents), deletes semaphore (DeleteSemaphore with 1-second delay). Exits with MAC_OK.",
      "tags": ["shutdown", "cleanup", "signal", "kill", "database_disconnect", "shared_memory_cleanup"],
      "dependencies": ["SQLMD_disconnect", "DisposeSockets", "KillAllExtents", "DeleteSemaphore"],
      "calls": ["GetSonsCount", "RewindTable", "ActItems", "kill", "access", "unlink", "time", "sprintf", "GerrLogMini", "SQLMD_disconnect", "DisposeSockets", "KillAllExtents", "usleep", "DeleteSemaphore", "exit", "_exit"],
      "kill_signals": {"SIGTERM": ["SQLPROC_TYPE", "AS400TOUNIX_TYPE", "DOCSQLPROC_TYPE", "PURCHASE_HIST_TYPE"], "Signal9": "default"},
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_father_008_sql_dbparam",
      "file": "FatherProcess.c",
      "type": "function",
      "function": "sql_dbparam_into_shm",
      "line_start": 1473,
      "line_end": 1597,
      "tokens": 1600,
      "summary": "Loads parameters from database setup table into shared memory parm_tablep. On reload, first deletes existing table contents. Declares and opens FP_setup_cur cursor, fetches program_name/parameter_name/parameter_value rows, builds par_key as 'program_name.param_name', stores in shared memory. Also adds UID, username, password, db to shared memory with ALL_PREFIX. Increments parameters revision in stat_tablep.",
      "tags": ["database", "parameters", "shared_memory", "cursor", "setup_table"],
      "dependencies": ["DeclareCursorInto", "OpenCursor", "FetchCursor", "CloseCursor", "AddItem", "DeleteTable", "ActItems"],
      "calls": ["DeleteTable", "DeclareCursorInto", "OpenCursor", "FetchCursor", "CloseCursor", "SQLERR_code_cmp", "SQLERR_error_test", "SQLMD_is_null", "sprintf", "AddItem", "GerrLogMini", "sleep", "strcpy", "ActItems"],
      "data_structures": ["PARM_DATA"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_father_009_sqlgetparams",
      "file": "FatherProcess.c",
      "type": "function",
      "function": "SqlGetParamsByName",
      "line_start": 1601,
      "line_end": 1757,
      "tokens": 2100,
      "summary": "Gets parameters from database by program name using FP_params_cur cursor. Fetches parameter_name, parameter_value, and instance control fields (program_type, instance_control, startup_instances, max_instances, min_free_instances). Populates InstanceControl array for valid Program... parameters. Updates prog_params array with typed values (PAR_INT, PAR_LONG, PAR_DOUBLE, PAR_CHAR). Validates all required parameters were found.",
      "tags": ["database", "parameters", "cursor", "instance_control", "configuration"],
      "dependencies": ["DeclareCursor", "OpenCursor", "FetchCursorInto", "CloseCursor"],
      "calls": ["strcpy", "DeclareCursor", "OpenCursor", "FetchCursorInto", "CloseCursor", "SQLERR_code_cmp", "SQLERR_error_test", "strstr", "strcmp", "atoi", "atol", "atof", "GerrLogMini", "sleep"],
      "data_structures": ["ParamTab", "TInstanceControl"],
      "param_types": ["PAR_INT", "PAR_LONG", "PAR_DOUBLE", "PAR_CHAR"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_father_010_run_system",
      "file": "FatherProcess.c",
      "type": "function",
      "function": "run_system",
      "line_start": 1761,
      "line_end": 1884,
      "tokens": 1700,
      "summary": "Runs child processes from shared memory parameters table for specified system flags. Opens PARM_TABLE, iterates looking for 'Program...' entries. For each program: gets its 'system' parameter, matches against running_system bitmap, finds its InstanceControl entry, starts startup_instances copies via Run_server(). Tracks instances_running in InstanceControl array.",
      "tags": ["process_spawn", "startup", "run_server", "instance_control", "child_processes"],
      "dependencies": ["OpenTable", "ActItems", "GetProgParm", "Run_server", "CloseTable"],
      "calls": ["sprintf", "strlen", "OpenTable", "ActItems", "strncmp", "strcpy", "GetProgParm", "strstr", "memset", "strcmp", "GerrLogMini", "Run_server", "CloseTable"],
      "data_structures": ["PROC_DATA", "PARM_DATA", "TInstanceControl"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_father_011_getprogparm",
      "file": "FatherProcess.c",
      "type": "function",
      "function": "GetProgParm",
      "line_start": 1888,
      "line_end": 1926,
      "tokens": 500,
      "summary": "Finds parameter value for a specific program from shared memory parm_tablep. Builds search key as 'prog_name.param_name', iterates through table using ActItems, returns matching par_val.",
      "tags": ["parameters", "lookup", "shared_memory", "utility"],
      "dependencies": ["OpenTable", "ActItems", "CloseTable"],
      "calls": ["OpenTable", "sprintf", "strlen", "ActItems", "strncmp", "strcpy", "CloseTable"],
      "data_structures": ["PARM_DATA"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_father_012_terminate_handler",
      "file": "FatherProcess.c",
      "type": "function",
      "function": "TerminateHandler",
      "line_start": 1930,
      "line_end": 1972,
      "tokens": 500,
      "summary": "Signal handler for terminating/fatal signals (SIGTERM, SIGFPE, SIGSEGV). Resets signal handling via sigaction, sets global caught_signal variable, logs friendly message describing signal type. Triggers orderly shutdown of Maccabi system.",
      "tags": ["signal_handler", "SIGTERM", "shutdown", "error_handling"],
      "dependencies": ["sigaction", "GerrLogMini"],
      "calls": ["sigaction", "GerrLogMini"],
      "signals_handled": ["SIGFPE", "SIGSEGV", "SIGTERM"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_father_013_odbc_operators",
      "file": "MacODBC_MyOperators.c",
      "type": "file_complete",
      "line_start": 1,
      "line_end": 115,
      "tokens": 1400,
      "summary": "ODBC SQL operator definitions for FatherProcess. Defines FP_params_cur (SELECT from setup_new for parameters with instance control fields) and FP_setup_cur (SELECT all from setup_new ordered by program_name, parameter_name). Includes GenSql_ODBC_Operators.c for shared operators.",
      "tags": ["database", "odbc", "sql", "cursor", "operators"],
      "dependencies": ["GenSql_ODBC_Operators.c"],
      "sql_cursors": {
        "FP_params_cur": "SELECT parameter_name, parameter_value, program_type, instance_control, startup_instances, max_instances, min_free_instances FROM setup_new WHERE program_name = ? OR program_name = ?",
        "FP_setup_cur": "SELECT program_name, parameter_name, parameter_value FROM setup_new ORDER BY program_name, parameter_name"
      },
      "complexity": "low"
    }
  ]
}
