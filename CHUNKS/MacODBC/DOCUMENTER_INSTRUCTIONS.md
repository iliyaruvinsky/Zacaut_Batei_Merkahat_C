# Chunker Output - Instructions for Documenter

**Generated by:** CIDRA Chunker Agent (CH)
**Task ID:** CH-MACODBC-001
**Date:** 2026-02-11
**Status:** COMPLETE

---

## Run Information

| Metric | Value |
|--------|-------|
| Component | MacODBC |
| Chunks Created | 25 |
| Total Lines | 4121 |
| Total Files | 1 (hybrid header/implementation) |
| Language | C |
| Strategy | Mixed section-level (header) + function-level (implementation) with ODBC_Exec sub-chunking into 8 phases |

---

## Key Findings

### System Role
- **MacODBC.h is the central ODBC infrastructure** for the entire MACCABI Healthcare C Backend system
- Replaces the previous Informix Embedded SQL (ESQL) approach with ODBC — supporting simultaneous MS-SQL + Informix connections
- Written by **Don Radlauer, December 2019**
- Hybrid header/implementation file: all code is guarded by `#ifdef MAIN` — the `.c` file that defines `MAIN` before including this header gets the implementation compiled into it

### Architecture: Single Dispatcher Pattern
- **25 public API macros** (DeclareCursor, ExecSQL, CommitWork, etc.) all route to a single **2,212-line `ODBC_Exec()` function**
- ODBC_Exec uses a `ODBC_CommandType` enum to determine behavior (prepare, execute, fetch, commit, rollback, etc.)
- The dispatcher is sub-chunked into 8 sequential phases: command decode → first-call init → operation metadata → sticky lifecycle → SQL construction → pointer validation & binding → execute/mirror/fetch → transaction/close/return

### Database Mirroring
- Write operations can be **mirrored to an alternate database** (e.g., MS-SQL primary + Informix mirror)
- Controlled globally by `ODBC_MIRRORING_ENABLED` and per-operation by `CommandIsMirrored`
- Mirror execute happens **first** (before primary) — mirror failures are logged but non-fatal
- Transaction commits use ENV-level SQLEndTran when both DBs were used, DBC-level when only one

### Sticky Statement Cache
- Prepared statements can be cached across calls via `StatementPrepared[]`/`StatementIsSticky[]` arrays
- Maximum 120 sticky statements (`ODBC_MAX_STICKY_STATEMENTS`)
- Admission control: when limit reached, new statements lose stickiness with diagnostic log
- Prepared-state validation: `SQLNumParams` probe before re-use; on failure, forces re-PREPARE

### SIGSEGV-Based Pointer Validation
- **Highly unusual pattern**: validates va_arg pointers by deliberately dereferencing them inside a `sigsetjmp`/`siglongjmp` block
- If the pointer causes SIGSEGV, the signal handler (`macODBC_SegmentationFaultCatcher`) sets `ODBC_PointerIsValid=0` and jumps back safely
- Guards both read-only (CHECK_VALIDITY_ONLY) and write (CHECK_POINTER_IS_WRITABLE) access

### Auto-Reconnect Mechanism
- Connection failures, TCP errors, and transaction-killed-by-other-session errors are **converted to `DB_CONNECTION_BROKEN`**
- Callers are expected to retry; on next call, `ODBC_Exec_FirstTimeCalled` is reset, triggering full re-initialization
- The error handler (`ODBC_ErrorHandler`) performs the disconnect + state reset

### Include Injection Pattern (Critical Cross-Reference)
- `SQL_GetMainOperationParameters()` at line 2747: `#include "MacODBC_MyOperators.c"` — injects per-component operator switch cases
- `SQL_GetWhereClauseParameters()` at line 2866: `#include "MacODBC_MyCustomWhereClauses.c"` — injects per-component WHERE clause switch cases
- Each component (FatherProcess, SqlServer, ShrinkPharm, etc.) provides its own versions of these files

---

## Chunk Index

### Header Sections (lines 1-420)
| Chunk ID | Lines | Token Est. | Summary |
|----------|-------|------------|---------|
| ch_macodbc_001_header | 1-44 | 310 | File header, include guards, ODBC system includes, project includes |
| ch_macodbc_002_constants | 47-101 | 390 | #define constants: sticky limits, pointer validation flags, parameter limits |
| ch_macodbc_003_enums | 104-151 | 340 | 3 enums: ODBC_DatabaseProvider, ODBC_CommandType (20 values), tag_bool |
| ch_macodbc_004_structs_globals | 153-273 | 850 | ODBC_DB_HEADER, ODBC_ColumnParams structs; all globals under #ifdef MAIN |
| ch_macodbc_005_macros | 276-336 | 430 | 25 public API wrapper macros routing to ODBC_Exec |
| ch_macodbc_007_error_enum | 338-348 | 120 | ODBC_ErrorCategory enum + 3 error handler wrapper macros |
| ch_macodbc_006_declarations | 351-420 | 490 | All 11 function prototypes + SIGSEGV_Handler function pointer |

### ODBC_Exec Dispatcher (lines 422-2657, sub-chunked into 8 phases)
| Chunk ID | Lines | Token Est. | Phase | Summary |
|----------|-------|------------|-------|---------|
| ch_macodbc_010a_cmd_decode | 422-772 | 2460 | Command decode & init | Function entry, variables, va_start, command-type switch (20 cases) |
| ch_macodbc_010b_first_call | 775-887 | 790 | First-call initialization | memset cache arrays, SIGSEGV handler install, bool-size probe |
| ch_macodbc_010c_op_metadata | 888-1072 | 1300 | Operation metadata loading | SQL_GetMainOperationParameters, mirroring logic, WHERE clause resolution |
| ch_macodbc_010d_sticky | 1075-1231 | 1100 | Sticky statement lifecycle | Provider-switch handling, admission control, prepared-state validation |
| ch_macodbc_010e_sql_construct | 1233-1447 | 1510 | SQL construction & prepare | Buffer assembly, token rewriting, SQLPrepare, auto-reconnect on failure |
| ch_macodbc_010f_bind | 1449-1976 | 3700 | Pointer validation & binding | SIGSEGV pointer probing, SQLBindCol, SQLBindParameter, mirror binding |
| ch_macodbc_010g_execute | 1978-2288 | 2180 | Execute, mirror, fetch | SQLExecute (mirror first), error categorization, SQLFetchScroll, cardinality |
| ch_macodbc_010h_txn_close | 2290-2657 | 2580 | Transaction, close, return | Commit/rollback (ENV vs DBC), isolation levels, cursor close, statement free |

### Helper Functions (lines 2661-4121)
| Chunk ID | Lines | Token Est. | Function | Summary |
|----------|-------|------------|----------|---------|
| ch_macodbc_020_getmainop | 2661-2817 | 1100 | SQL_GetMainOperationParameters | Resolves OperationID → SQL metadata; **#include injection at 2747** |
| ch_macodbc_021_getwhere | 2821-2902 | 580 | SQL_GetWhereClauseParameters | Resolves WhereClauseID → text + input cols; **#include injection at 2866** |
| ch_macodbc_022_customizedb | 2906-3136 | 1620 | SQL_CustomizePerDB | Provider-specific token rewriting: {MODULO}, {TOP}, {TRANSACTION}, {GROUP} |
| ch_macodbc_023_parsecols | 3140-3330 | 1340 | ParseColumnList | Parses column-spec strings into ODBC_ColumnParams array (12 C types supported) |
| ch_macodbc_024_findforupdate | 3334-3439 | 740 | find_FOR_UPDATE_or_GEN_VALUES | SQL tokenizer: detects INSERT, SELECT, FOR UPDATE, WHERE insertion points |
| ch_macodbc_025_connect | 3443-3794 | 2460 | ODBC_CONNECT | Full connection lifecycle: env alloc, connect, MS-SQL post-setup, Informix config |
| ch_macodbc_026_cleanup | 3798-3819 | 155 | CleanupODBC | Disconnect + free; env release when last DB disconnects |
| ch_macodbc_027_errorhandler | 3823-4004 | 1280 | ODBC_ErrorHandler | Centralized: SQLGetDiagRec, synthetic error conversion, auto-reconnect trigger |
| ch_macodbc_028_isvalidptr | 4013-4070 | 410 | ODBC_IsValidPointer | sigsetjmp/siglongjmp pointer probing — read and optional write validation |
| ch_macodbc_029_segfaultcatcher | 4073-4118 | 325 | macODBC_SegmentationFaultCatcher | SIGSEGV handler: validation mode → siglongjmp; normal mode → fatal shutdown |

---

## Recommended Documentation Order

### Phase 1: Public Interface (start here)
1. **ch_macodbc_005_macros** — Document the 25 public API macros first. This is what every component developer sees and uses. Show the macro-to-CommandType mapping.
2. **ch_macodbc_003_enums** — Document ODBC_CommandType (the command vocabulary), ODBC_DatabaseProvider (supported databases), and tag_bool.
3. **ch_macodbc_004_structs_globals** — Document ODBC_DB_HEADER and ODBC_ColumnParams structs, then the critical global variables (MAIN_DB/ALT_DB, mirroring state, sticky arrays).
4. **ch_macodbc_002_constants** — Document the configuration constants that control behavior (sticky limits, pointer validation toggles).

### Phase 2: ODBC_Exec Flow (the core)
5. **ch_macodbc_010a_cmd_decode** — Entry point and command-type switch. Explain the flag-based dispatch model.
6. **ch_macodbc_010b_first_call** — One-time initialization. Explain the SIGSEGV handler installation and bool probe.
7. **ch_macodbc_010c_op_metadata** — How operation metadata is loaded. Introduce the include-injection pattern. Explain mirroring decision logic.
8. **ch_macodbc_010d_sticky** — Sticky statement lifecycle. Document admission control, provider-switch handling, validation.
9. **ch_macodbc_010e_sql_construct** — SQL buffer assembly, token rewriting, SQLPrepare. Document the auto-reconnect trigger path.
10. **ch_macodbc_010f_bind** — Pointer validation and ODBC binding. **This is the largest chunk (3700 tokens)** — document in two logical sections: pointer collection then binding loops.
11. **ch_macodbc_010g_execute** — Execution flow including mirror-first strategy. Document error categorization and the silent-INSERT-failure detection.
12. **ch_macodbc_010h_txn_close** — Commit/rollback mechanics (ENV vs DBC level), isolation setting, cursor close, statement free, cleanup.

### Phase 3: Helper Functions
13. **ch_macodbc_020_getmainop** + **ch_macodbc_021_getwhere** — Document together as the "operation resolution layer." Highlight the **#include injection boundaries** at lines 2747 and 2866.
14. **ch_macodbc_022_customizedb** — Provider-specific SQL dialect bridging. Show all 4 token substitution patterns.
15. **ch_macodbc_023_parsecols** — Column specification parser. Document all 12 supported C type mappings.
16. **ch_macodbc_024_findforupdate** — SQL structure detection utility.

### Phase 4: Connection & Error Handling
17. **ch_macodbc_025_connect** — Full connection establishment. Document MS-SQL vs Informix setup differences.
18. **ch_macodbc_026_cleanup** — Disconnection and environment release.
19. **ch_macodbc_027_errorhandler** — Centralized error handler. **Document the synthetic error conversion** (access-conflict → -243) and **auto-reconnect conversion** (TCP error → DB_CONNECTION_BROKEN) in detail.

### Phase 5: Pointer Validation Mechanism
20. **ch_macodbc_028_isvalidptr** + **ch_macodbc_029_segfaultcatcher** — Document together as the "SIGSEGV pointer validation system." This is **highly unusual** — explain the sigsetjmp/siglongjmp flow, the dual-mode handler (validation vs fatal), and why this pattern exists (variadic arguments cannot be type-checked at compile time).

### Phase 6: Remaining Headers
21. **ch_macodbc_001_header** — Include chain and system dependencies.
22. **ch_macodbc_007_error_enum** + **ch_macodbc_006_declarations** — Error categories and complete prototype index.

---

## Special Documentation Needs

### 1. Database Mirroring Flow (spans 6 chunks)
Document the full mirroring data flow across these chunks:
- **010c**: Mirroring decision (CommandIsMirrored = ODBC_MIRRORING_ENABLED && per-op flag && not SELECT)
- **010d**: Mirror statement allocation
- **010e**: Mirror SQLPrepare
- **010f**: Mirror SQLBindParameter for input and WHERE columns
- **010g**: Mirror SQLExecute (happens BEFORE primary), mirror error handling, MIRROR_SQLCODE/MIRROR_ROWS_AFFECTED
- **010h**: Mirror cursor close, mirror statement free, ENV-level commit when both DBs used

### 2. Sticky Statement Lifecycle (spans 4 chunks)
- **002**: ODBC_MAX_STICKY_STATEMENTS constant (120)
- **004**: StatementPrepared[], StatementIsSticky[], StatementOpened[] arrays
- **010b**: Array initialization on first call
- **010d**: Full lifecycle — provider switch, admission control, prepared-state validation, allocation

### 3. Auto-Reconnect Mechanism (spans 3 chunks)
- **010e**: SQLPrepare failure → SQLMD_disconnect + FirstTimeCalled reset → return DB_CONNECTION_BROKEN
- **010g**: SQLExecute failure for TCP/transaction errors → same disconnect path
- **027**: ODBC_ErrorHandler converts specific native errors → DB_CONNECTION_BROKEN + state reset

### 4. SIGSEGV Pointer Validation (spans 3 chunks)
- **010b**: Signal handler installation via sigaction
- **010f**: Pointer collection loop with ODBC_IsValidPointer calls
- **028** + **029**: The sigsetjmp/siglongjmp mechanism and dual-mode handler

### 5. Include Injection Pattern (critical for component developers)
- **020**: `#include "MacODBC_MyOperators.c"` at line 2747 — each component provides its own operator definitions
- **021**: `#include "MacODBC_MyCustomWhereClauses.c"` at line 2866 — each component provides its own WHERE clauses
- List all known component files (see analysis.json `cross_file_dependencies.known_component_files`)

---

## Cross-References

### External Dependencies (must document interactions)

| Library/File | Key Functions | Purpose |
|-------------|---------------|---------|
| sql.h, sqlext.h | SQLAllocEnv, SQLConnect, SQLPrepare, SQLExecute, SQLBindCol, SQLBindParameter, SQLFetchScroll, SQLEndTran, etc. | ODBC API |
| GenSql.h | SQLMD_connect, SQLMD_disconnect, INF_CONNECT, ODBC_MAXIMUM_OPERATION | SQL infrastructure |
| GenSql.c | INF_CONNECT() | Calls ODBC_CONNECT; is the external entry point for connection |
| MacODBC_MyOperatorIDs.h | Operator ID enums | Per-component operation identifiers |
| MacODBC_MyOperators.c | Switch cases | Per-component SQL definitions (injected at line 2747) |
| MacODBC_MyCustomWhereClauses.c | Switch cases | Per-component WHERE clauses (injected at line 2866) |

### Known Component Files (8 components use MacODBC)

| Component | MacODBC_MyOperators.c | MacODBC_MyCustomWhereClauses.c |
|-----------|----------------------|-------------------------------|
| FatherProcess | Yes | Yes |
| SqlServer | Yes | Yes |
| As400UnixServer | Yes | Yes |
| As400UnixClient | Yes | Yes |
| As400UnixDocServer | Yes | Yes |
| As400UnixDoc2Server | Yes | Yes |
| ShrinkPharm | Yes | Yes |
| GenSql | Yes | N/A |

---

## Warnings and Notes

### Anti-Hallucination
- All line numbers have been verified by reading the entire 4,121-line file across 14 passes
- All function boundaries have been confirmed against actual code
- Do NOT invent functions, macros, or features not present in the chunks
- Every claim must be traceable to a specific chunk and line range

### Security Considerations
- Database credentials are passed to ODBC_CONNECT as plain-text parameters (DSN, username, password)
- `setlocale(LC_ALL, "he_IL.UTF-8")` is called during connection — Hebrew locale dependency
- Lock timeout and deadlock priority are configurable but hardcoded in the connect function
- Document credential flow but **do not copy actual values** from calling code

### Legacy Code Notes
- Commented-out `{ROWID}` support in SQL_CustomizePerDB (lines 3021-3055) — Oracle-specific, never completed
- The `ExecSql` macro (lowercase 'q') at line 319 is a duplicate of `ExecSQL` (uppercase 'Q') at line 318 — both exist for backward compatibility
- `RollBackWork` vs `RollbackWork` — both spellings exist as macros for the same operation
- BoolType probe at lines 836-845: runtime detection of `sizeof(bool)` because different C compilers map bool to different sizes (1 vs 4 bytes)

### Complexity Warning
- ch_macodbc_010f_bind is the largest chunk at ~3700 tokens — consider documenting its two logical phases (pointer collection + ODBC binding) separately in the output
- ODBC_Exec as a whole is 2,212 lines — the documenter should maintain a flow narrative across all 8 sub-chunks

---

## Files Reference

```
CHUNKS/MacODBC/
├── repository.json             # All 25 chunks with full metadata
├── graph.json                  # Dependency graph: 25 nodes, 24 edges, 3 groups
├── analysis.json               # Statistics, complexity assessment, key patterns
├── run_manifest.json           # Execution metadata (this run)
└── DOCUMENTER_INSTRUCTIONS.md  # This file
```

---

## Next Steps for Documenter

1. Read `repository.json` to access all 25 chunk definitions with summaries and metadata
2. Read `graph.json` to understand call relationships and data flow between chunks
3. Read `analysis.json` for statistics, key patterns, and cross-file dependency catalog
4. Read `RESEARCH/MacODBC_deepdive.md` for the Researcher agent's deep-dive analysis
5. Follow the recommended documentation order above (6 phases)
6. Generate 7-file documentation set per CIDRA standards
7. Pay special attention to the 5 cross-cutting concerns documented under "Special Documentation Needs"
8. Achieve 100/100 validation score

---

*Generated by CIDRA Chunker Agent*
*Task CH-MACODBC-001 COMPLETE*
