{
  "metadata": {
    "project": "MACCABI Healthcare C Backend",
    "component": "SqlServer",
    "chunked_at": "2026-02-13T00:00:00Z",
    "task_id": "CH-SQL-001",
    "total_chunks": 62,
    "total_lines": 83983,
    "total_files": 13,
    "language": "C",
    "description": "Primary pharmacy server process handling ~60+ transaction codes via central dispatch switch. Processes electronic prescriptions (2xxx), digital prescriptions (6xxx), Nihul Tikrot subsidies (5xxx), and pharmacy management (1xxx) transactions."
  },
  "chunks": [
    {
      "chunk_id": "ch_sql_001_globals",
      "file": "source_code/SqlServer/SqlServer.c",
      "type": "section",
      "section": "Globals & Includes",
      "line_start": 1,
      "line_end": 128,
      "tokens": 450,
      "summary": "#define MAIN instantiates MacODBC globals. Includes MacODBC.h, MsgHndlr.h. Defines global variables: accept_sock, mypid, message_count, caught_signal, no_vat_multiplier. Enum SEND_STATES {BEFORE_UPDATE, AFTER_UPDATE, CONN_HANGUP}. Forward declarations for all signal handlers and utility functions.",
      "tags": ["header", "globals", "main_instantiation"],
      "dependencies": [],
      "calls": [],
      "called_by": [],
      "cross_refs": ["MacODBC.h (#define MAIN)", "MsgHndlr.h (global runtime parameters)"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_002_startup",
      "file": "source_code/SqlServer/SqlServer.c",
      "type": "function",
      "section": "Startup Init (main entry)",
      "line_start": 129,
      "line_end": 280,
      "tokens": 530,
      "summary": "main() entry point. Calls GetCommonPars, InitSonProcess(SQLPROC_TYPE, PHARM_SYS). Installs signal handlers: SIGPIPE→ClosedPipeHandler, SIGTERM→TerminateHandler, SIGFPE→TerminateHandler, SIGSEGV→SetCustomSegmentationFaultHandler, SIGUSR1→NihulTikrotEnableHandler, SIGUSR2→NihulTikrotDisableHandler.",
      "tags": ["main_entry", "init", "signal_setup"],
      "dependencies": ["ch_sql_001_globals"],
      "calls": ["GetCommonPars", "InitSonProcess", "SetCustomSegmentationFaultHandler"],
      "called_by": [],
      "cross_refs": ["FatherProcess (parent supervisor)", "MacODBC.h:SetCustomSegmentationFaultHandler"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_003_dbconnect",
      "file": "source_code/SqlServer/SqlServer.c",
      "type": "function",
      "section": "DB Connect + Sysparams Load",
      "line_start": 281,
      "line_end": 626,
      "tokens": 1210,
      "summary": "Sets LOCK_TIMEOUT=250, DEADLOCK_PRIORITY=8, ODBC_PRESERVE_CURSORS=0. SQLMD_connect() retry loop. Loads illness bitmaps via bypass_basket_cur. Massive ExecSQL READ_sysparams populating ~70+ global parameters from MsgHndlr.h. Calls init_package_size_array(), LoadTrnPermissions(), LoadPrescrSource(), InitTikrotSP().",
      "tags": ["init", "database", "sysparams", "configuration"],
      "dependencies": ["ch_sql_002_startup"],
      "calls": ["SQLMD_connect", "ExecSQL(bypass_basket_cur)", "ExecSQL(READ_sysparams)", "init_package_size_array", "LoadTrnPermissions", "LoadPrescrSource", "InitTikrotSP"],
      "called_by": [],
      "cross_refs": ["MsgHndlr.h (70+ sysparams globals)", "MacODBC_MyOperatorIDs.h (bypass_basket_cur, READ_sysparams)"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_004_mainloop",
      "file": "source_code/SqlServer/SqlServer.c",
      "type": "function",
      "section": "Steady-State Main Loop",
      "line_start": 627,
      "line_end": 952,
      "tokens": 1140,
      "summary": "while(1) loop: UpdateShmParams, ToGoDown check, caught_signal handling. GetSocketMessage(5000000 timeout) for client requests. Calls MakeAndSendReturnMessage for dispatch. UpdateLastAccessTime, process_spools. Hourly refresh: re-reads sysparams, calls init_package_size_array, GET_ERROR_SEVERITY, LoadTrnPermissions, LoadPrescrSource. SetFreeSqlServer at end of each iteration.",
      "tags": ["main_loop", "dispatch_entry", "hourly_refresh"],
      "dependencies": ["ch_sql_003_dbconnect"],
      "calls": ["UpdateShmParams", "GetSocketMessage", "MakeAndSendReturnMessage", "process_spools", "SetFreeSqlServer"],
      "called_by": [],
      "cross_refs": ["FatherProcess (shared memory via UpdateShmParams/SetFreeSqlServer)"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_005_dispatch_pre",
      "file": "source_code/SqlServer/SqlServer.c",
      "type": "sub_chunk",
      "section": "Dispatch Preamble (MakeAndSendReturnMessage start)",
      "line_start": 955,
      "line_end": 1285,
      "tokens": 1160,
      "summary": "MakeAndSendReturnMessage() function start. JSON request parsing via cJSON: looks for PharmServerRequest.request_number. Falls back to binary message format. Pre-dispatch logging: INS_messages_details, UPD/INS_sql_srv_audit. Sets up error tracking, message headers, and audit trail before dispatch switch.",
      "tags": ["dispatch", "json_parsing", "audit_logging", "cjson"],
      "dependencies": ["ch_sql_004_mainloop"],
      "calls": ["cJSON_Parse", "ExecSQL(INS_messages_details)", "ExecSQL(INS_sql_srv_audit)"],
      "called_by": ["ch_sql_004_mainloop"],
      "cross_refs": ["PharmDBMsgs.h (wire protocol structs)", "cJSON library"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_006_dispatch_switch",
      "file": "source_code/SqlServer/SqlServer.c",
      "type": "sub_chunk",
      "section": "Central Dispatch Switch (~60+ transaction codes)",
      "line_start": 1286,
      "line_end": 1687,
      "tokens": 1410,
      "summary": "Central switch(MsgIndex) routing ~60+ transaction codes to handler functions. Families: 1xxx (pharmacy ops: 1001,1011,1013,1014,1022,1026,1028,1043,1047,1049,1051,1053,1055,1080), 2xxx (electronic Rx: 2001,2003,2005,2033,2060-2068,2070-2096,2101), 5xxx (Nihul Tikrot: 5003,5005,5051-5061,5090), 6xxx (digital Rx: 6001,6003,6005,6011,6022,6033,6101-6103). Default: ERR_ILLEGAL_MESSAGE_CODE.",
      "tags": ["dispatch", "transaction_routing", "central_switch"],
      "dependencies": ["ch_sql_005_dispatch_pre"],
      "calls": ["HandlerToMsg_1001", "HandlerToMsg_2001", "HandlerToMsg_2003", "HandlerToMsg_5003", "HandlerToMsg_6001_6101", "HandlerToMsg_6003"],
      "called_by": ["ch_sql_005_dispatch_pre"],
      "cross_refs": ["All handler chunks in SqlHandlers.c, ElectronicPr.c, DigitalRx.c"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_007_post_dispatch",
      "file": "source_code/SqlServer/SqlServer.c",
      "type": "sub_chunk",
      "section": "Post-Dispatch (statistics, socket output, cleanup)",
      "line_start": 1689,
      "line_end": 1918,
      "tokens": 805,
      "summary": "Post-dispatch processing: spool error check, UpdateTimeStat, UPD_messages_details, UPD_sql_srv_audit_NotInProgress. Socket response: WriteSocket(output_type_flg + output_buf), CloseSocket. JSON cleanup: cJSON_Delete. Handles both realtime and spooled response paths.",
      "tags": ["post_dispatch", "socket_output", "statistics", "cleanup"],
      "dependencies": ["ch_sql_006_dispatch_switch"],
      "calls": ["WriteSocket", "CloseSocket", "cJSON_Delete", "ExecSQL(UPD_messages_details)"],
      "called_by": [],
      "cross_refs": ["SocketAPI.c (WriteSocket/CloseSocket)"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_008_signal_handlers",
      "file": "source_code/SqlServer/SqlServer.c",
      "type": "function",
      "section": "Signal Handlers",
      "line_start": 1920,
      "line_end": 2217,
      "tokens": 1040,
      "summary": "ClosedPipeHandler (SIGPIPE): closes socket on broken pipe. BUG at line 1940: accept_sock == -1 is comparison not assignment [NEEDS_VERIFICATION]. TerminateHandler (SIGSEGV/SIGTERM/SIGFPE): SIGSEGV passes through to ODBC pointer validation via siglongjmp; endless loop detection; signal-specific descriptions. NihulTikrotEnableHandler (SIGUSR1): sets TikrotRPC_Enabled=1. NihulTikrotDisableHandler (SIGUSR2): sets TikrotRPC_Enabled=0. TerminateProcess: graceful shutdown with UPD_sql_srv_audit_ProgramEnd, SQLMD_disconnect, ExitSonProcess. DiffTime: millisecond diff utility.",
      "tags": ["signal_handler", "SIGPIPE", "SIGSEGV", "SIGTERM", "SIGUSR1", "SIGUSR2", "NEEDS_VERIFICATION"],
      "dependencies": ["ch_sql_001_globals"],
      "calls": ["SQLMD_disconnect", "ExitSonProcess", "ExecSQL(UPD_sql_srv_audit_ProgramEnd)"],
      "called_by": [],
      "cross_refs": ["MacODBC.h (SIGSEGV passthrough for pointer validation)"],
      "complexity": "high",
      "verification_items": ["Line 1940: accept_sock == -1 appears to be comparison (==) instead of assignment (=) — potential bug causing socket leak"]
    },
    {
      "chunk_id": "ch_sql_009_cache_loaders",
      "file": "source_code/SqlServer/SqlServer.c",
      "type": "function",
      "section": "Cache Loaders",
      "line_start": 2220,
      "line_end": 2362,
      "tokens": 500,
      "summary": "LoadPrescrSource (2220-2282): loads PrescrSource[] array from prescr_source table via cursor. LoadTrnPermissions (2285-2362): loads TrnPermissions[] array from pharm_trn_permit table via cursor. Both are refreshed hourly from the main loop.",
      "tags": ["cache_loader", "prescr_source", "trn_permissions"],
      "dependencies": ["ch_sql_001_globals"],
      "calls": ["DeclareCursor(LoadPrescSourceCur)", "DeclareCursor(LoadTrnPermitCur)"],
      "called_by": ["ch_sql_003_dbconnect", "ch_sql_004_mainloop"],
      "cross_refs": ["MsgHndlr.h (PrescrSource[], TrnPermissions[] globals)", "MacODBC_MyOperatorIDs.h (LoadPrescSourceCur, LoadTrnPermitCur)"],
      "complexity": "low"
    },

    {
      "chunk_id": "ch_sql_010_sqlhdl_header",
      "file": "source_code/SqlServer/SqlHandlers.c",
      "type": "section",
      "section": "Header, Globals, Decision Tables",
      "line_start": 1,
      "line_end": 394,
      "tokens": 1380,
      "summary": "Includes MacODBC.h, MsgHndlr.h, PharmacyErrors.h, TikrotRPC.h. Macros: Conflict_Test, pharmacy-type macros, DUR/OD test macros. Static decision tables: DurDecisionTable[2][2][2][6], OD_DecisionTable[2][4][5] for DUR/overdose severity decisions. Static counters for T2003 statistics. presc_err_comp: qsort comparator sorting PRESC_ERR by check_type (DUR before OVERDOSE), severity, drug code.",
      "tags": ["header", "globals", "decision_tables", "qsort_comparator"],
      "dependencies": [],
      "calls": [],
      "called_by": [],
      "cross_refs": ["MsgHndlr.h", "PharmacyErrors.h"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_011_trn1001",
      "file": "source_code/SqlServer/SqlHandlers.c",
      "type": "function",
      "section": "Transaction 1001: Open Shift",
      "line_start": 404,
      "line_end": 1000,
      "tokens": 2090,
      "summary": "HandlerToMsg_1001/HandlerToSpool_1001: thin wrappers calling GenHandlerToMsg_1001 with fromspool flag. GenHandlerToMsg_1001 (454-1000): validates pharmacy via IS_PHARMACY_OPEN_X, checks institute code, verifies/updates Maccabi price list, writes TR1001_INS_pharmacy_log, handles retry logic for access conflicts.",
      "tags": ["handler", "trn_1001", "open_shift", "template_pattern"],
      "dependencies": ["ch_sql_010_sqlhdl_header"],
      "calls": ["IS_PHARMACY_OPEN_X", "ExecSQL(TR1001_READ_Pharmacy)", "ExecSQL(TR1001_INS_pharmacy_log)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MessageFuncs.c:IS_PHARMACY_OPEN_X", "MacODBC_MyOperators.c:TR1001_*"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_012_trn1011_1014",
      "file": "source_code/SqlServer/SqlHandlers.c",
      "type": "function",
      "section": "Transactions 1011/1013/1014: Drug List, Close Shift, Price List",
      "line_start": 1010,
      "line_end": 2308,
      "tokens": 2835,
      "summary": "DownloadDrugList (1010-1496): downloads drug records from DB to file for TR1011/TR2094, handles drug deletion/update codes, pharmacy category filtering (Maccabi/Assuta). GenHandlerToMsg_1013 (1556-1819): close shift handler, records closing code/date/hour with retry logic. HandlerToMsg_1014 (1830-2308): price list download to file, supports custom WHERE clauses and multiple cursor modes.",
      "tags": ["handler", "trn_1011", "trn_1013", "trn_1014", "download", "file_output", "template_pattern"],
      "dependencies": ["ch_sql_010_sqlhdl_header"],
      "calls": ["DeclareCursor(TR1011_2094_DrugListDownload_cur)", "ExecSQL(TR1013_INS_pharmacy_log)", "DeclareCursor(TR1014_PriceList_cur)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR1011_*, TR1013_*, TR1014_*"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_013_trn1022_1028",
      "file": "source_code/SqlServer/SqlHandlers.c",
      "type": "function",
      "section": "Transactions 1022/6022/1026/1028: Stock Entry, Text Messages, Financial Status",
      "line_start": 2322,
      "line_end": 3637,
      "tokens": 4600,
      "summary": "GENERIC_HandlerToMsg_1022_6022 (2322-2849): stock entry into STOCK and STOCK_REPORT tables with dynamic buffer allocation, supports realtime and spool modes. Thin wrappers at 2850-2867. HandlerToMsg_1026 (2878-3317): retrieves display messages for pharmacy terminals with special character filtering. HandlerToMsg_1028 (3327-3637): financial status/balance query for pharmacy.",
      "tags": ["handler", "trn_1022", "trn_6022", "trn_1026", "trn_1028", "stock_entry", "template_pattern"],
      "dependencies": ["ch_sql_010_sqlhdl_header"],
      "calls": ["ExecSQL(TR1022_INS_Stock)", "ExecSQL(TR1022_INS_StockReport)", "DeclareCursor(TR1026_message_id_cur)", "ExecSQL(TR1028_READ_PharmacyDailySum)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR1022_*, TR1026_*, TR1028_*"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_014_trn1043_1051",
      "file": "source_code/SqlServer/SqlHandlers.c",
      "type": "function",
      "section": "Transactions 1043/1047/1049/1051: Error Messages, Discount, Supplier, Centers Downloads",
      "line_start": 3648,
      "line_end": 5158,
      "tokens": 5290,
      "summary": "Four table-download handlers sharing common cursor-to-file pattern. HandlerToMsg_1043 (3648-3970): error message table download. HandlerToMsg_1047 (3982-4348): discount pricing rules download. HandlerToMsg_1049 (4359-4738): supplier/vendor records download. HandlerToMsg_1051 (4748-5158): pharmacy center master data download.",
      "tags": ["handler", "trn_1043", "trn_1047", "trn_1049", "trn_1051", "download", "file_output"],
      "dependencies": ["ch_sql_010_sqlhdl_header"],
      "calls": ["DeclareCursor(TR1043_error_messags_cur)", "DeclareCursor(TR1047_member_pric_up_cur)", "DeclareCursor(TR1049_supplier_up_cur)", "DeclareCursor(TR1051_centers_up_cur)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR1043_*, TR1047_*, TR1049_*, TR1051_*"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_015_trn1053_1055",
      "file": "source_code/SqlServer/SqlHandlers.c",
      "type": "function",
      "section": "Transactions 1053/1055: Money/Employee Items + DUR/OD Message Retrieval",
      "line_start": 5169,
      "line_end": 7054,
      "tokens": 6600,
      "summary": "GENERIC_HandlerToMsg_1053 (5169-5554): inserts into MONEY_EMPTY and MONEY_EMP_LINES tables with dynamic record allocation. HandlerToMsg_1055 (5566-7054, 1489 lines): retrieves and formats DUR/OD warning messages with multi-severity classification, dynamic variable substitution, message destination routing, prescription error sorting via presc_err_comp, title/detail/summary formatting. The largest function in SqlHandlers.c.",
      "tags": ["handler", "trn_1053", "trn_1055", "dur_od", "message_formatting"],
      "dependencies": ["ch_sql_010_sqlhdl_header", "ch_sql_017_dur_od_engine"],
      "calls": ["ExecSQL(TR1053_INS_money_empty)", "ExecSQL(TR1053_INS_money_emp_lines)", "DeclareCursor(TR1055_presc_mes_cur)", "DeclareCursor(TR1055_msg_fmt_cur)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR1053_*, TR1055_*"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_016_trn1080_wrappers",
      "file": "source_code/SqlServer/SqlHandlers.c",
      "type": "function",
      "section": "Transaction 1080 + Late Wrappers (1053, 1022)",
      "line_start": 7055,
      "line_end": 7426,
      "tokens": 1300,
      "summary": "HandlerToMsg_1053 (7055-7070): thin realtime wrapper for GENERIC_HandlerToMsg_1053. HandlerToMsg_1080 (7080-7382): pharmacy contract/authorization records download to file. HandlerToSpool_1022_6022 (7383-7401): thin spool wrapper for GENERIC_HandlerToMsg_1022_6022. HandlerToSpool_1053 (7410-7426): thin spool wrapper for GENERIC_HandlerToMsg_1053.",
      "tags": ["handler", "trn_1080", "wrapper", "download"],
      "dependencies": ["ch_sql_013_trn1022_1028", "ch_sql_015_trn1053_1055"],
      "calls": ["GENERIC_HandlerToMsg_1053", "GENERIC_HandlerToMsg_1022_6022", "DeclareCursor(TR1080_pharmacy_contract_cur)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR1080_*"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_017_dur_od_engine",
      "file": "source_code/SqlServer/SqlHandlers.c",
      "type": "function",
      "section": "Drug Interaction & Overdose Engine",
      "line_start": 7444,
      "line_end": 8458,
      "tokens": 3550,
      "summary": "test_interaction_and_overdose (7444-8267, 823 lines): core DUR/OD testing routine, checks drug-drug interactions within current prescription and against blood drug history (v_DrugsBuf), calculates accumulated dosage for overdose detection, handles duration-based arithmetic across overlapping prescriptions. write_interaction_and_overdose (8279-8442): persists validated DUR/OD error records to database for audit trail. log_serious_error_text/int (8443-8458): error logging utilities.",
      "tags": ["business_logic", "dur_od", "drug_interaction", "overdose_detection"],
      "dependencies": ["ch_sql_010_sqlhdl_header"],
      "calls": ["IS_DRUG_INTERACAT", "ExecSQL(IntOD_INS_presc_drug_inter)", "ExecSQL(IntOD_max_units)"],
      "called_by": ["ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_042_trn6003"],
      "cross_refs": ["MessageFuncs.c:IS_DRUG_INTERACAT", "MessageFuncs.c:get_drugs_in_blood", "MacODBC_MyOperators.c:IntOD_*"],
      "complexity": "very_high"
    },

    {
      "chunk_id": "ch_sql_020_epr_header",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "section",
      "section": "Header, Macros, Globals",
      "line_start": 1,
      "line_end": 222,
      "tokens": 670,
      "summary": "File split from SqlHandlers.ec for electronic prescription functions. Includes MacODBC.h, PharmacyErrors.h, MsgHndlr.h, MessageFuncs.h, TikrotRPC.h, As400UnixMediator.h. Global GerrSource, v_DrugsBuf, Form29gMessagesEnabled. ~30 macros: Conflict_Test, pharmacy-type, discount, illness-bitmap macros. Static/extern declarations and forward declarations.",
      "tags": ["header", "globals", "macros"],
      "dependencies": [],
      "calls": [],
      "called_by": [],
      "cross_refs": ["MsgHndlr.h", "PharmacyErrors.h", "MessageFuncs.h"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_021_trn2001",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Transaction 2001: Prescription Drugs List Request",
      "line_start": 223,
      "line_end": 1045,
      "tokens": 2880,
      "summary": "HandlerToMsg_2001 (823 lines): retrieves valid electronic prescriptions for a member. Reads member data, validates pharmacy, fetches prescription drug list from doctor_presc via cursor, checks special prescriptions, drug extensions, and participation rates. Returns formatted drug list to pharmacy terminal.",
      "tags": ["handler", "trn_2001", "prescription_list", "electronic_rx"],
      "dependencies": ["ch_sql_020_epr_header"],
      "calls": ["IS_PHARMACY_OPEN_X", "read_member", "DeclareCursor(TR2001_Rx_cursor)", "test_special_prescription", "FIND_DRUG_EXTENSION"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR2001_*", "MessageFuncs.c:IS_PHARMACY_OPEN_X"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_022_trn2003",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Transaction 2003: Electronic Prescription Drugs Sale",
      "line_start": 1057,
      "line_end": 5122,
      "tokens": 14230,
      "tokens_justification": "Single monolithic function HandlerToMsg_2003 (4066 lines) containing the complete electronic prescription sale workflow. Cannot be split at function boundaries. Recommended for sub-chunking by documenter into phases: input parsing → member/pharmacy validation → drug loop (pricing, participation, discounts, DUR/OD) → database writes → output formatting.",
      "summary": "HandlerToMsg_2003 (4066 lines): core electronic prescription drug sale handler. Processes the actual sale of prescribed drugs including: member and pharmacy validation, drug-by-drug processing loop with pricing calculation, participation determination (Maccabi vs private pharmacy), discount logic, Meishar AS/400 eligibility integration, bakara kamutit (quantity checking), specialist rules, DUR/overdose checking, purchase limit testing, error/warning assignment, database writes (INS_prescriptions, INS_prescription_drugs), and formatted output.",
      "tags": ["handler", "trn_2003", "drug_sale", "electronic_rx", "core_business_logic", "NEEDS_SUB_CHUNKING"],
      "dependencies": ["ch_sql_020_epr_header"],
      "calls": ["IS_PHARMACY_OPEN_X", "read_member", "read_drug", "test_special_prescription", "test_purchase_limits", "test_interaction_and_overdose", "test_pharmacy_ishur", "test_mac_doctor_drugs_electronic", "CheckHealthAlerts", "as400EligibilityTest", "GetParticipatingCode", "ExecSQL(TR2003_INS_prescriptions)", "ExecSQL(TR2003_INS_prescription_drugs)", "update_doctor_presc"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR2003_*", "MessageFuncs.c (all validation functions)", "As400UnixMediator.c:as400EligibilityTest", "SqlHandlers.c:test_interaction_and_overdose"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_023_trn2005",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Transaction 2005: Electronic Prescription Drugs Delivery",
      "line_start": 5135,
      "line_end": 7640,
      "tokens": 8770,
      "tokens_justification": "Two closely related delivery handlers (realtime 1236 lines + spool 1258 lines) that must stay together as a single transaction family. Splitting would break the realtime/spool comparison needed for documentation.",
      "summary": "HandlerToMsg_2005 (5135-6370, 1236 lines): electronic prescription drugs delivery in realtime mode. Finalizes a delivery after a 2003 sale: reads prescriptions, iterates prescription drugs cursor, updates prescription_drugs and prescriptions records, updates pharmacy_daily_sum, handles AS/400 gadget spool. HandlerToSpool_2005 (6383-7640, 1258 lines): same business logic in spooled/batch mode with commfail_flag parameter and additional recovery logic including duplicate-spool detection.",
      "tags": ["handler", "trn_2005", "delivery", "electronic_rx", "realtime_spool_pair"],
      "dependencies": ["ch_sql_020_epr_header", "ch_sql_022_trn2003"],
      "calls": ["DeclareCursor(TR2005_presc_drug_cur)", "ExecSQL(TR2005_UPD_prescription_drugs)", "ExecSQL(TR2005_UPD_prescriptions)", "ExecSQL(TR2005_UPD_pharmacy_daily_sum)", "as400SaveSaleRecord"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR2005_*, TR2005spool_*", "As400UnixMediator.c:as400SaveSaleRecord"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_024_trn5003",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Transaction 5003: Nihul Tikrot Subsidy Drugs Sale",
      "line_start": 7653,
      "line_end": 13598,
      "tokens": 20810,
      "tokens_justification": "Single monolithic function HandlerToMsg_5003 (5946 lines) — the largest function in the entire codebase. Contains complete Nihul Tikrot subsidy sale workflow mirroring TR2003 logic but with additional subsidy-specific calculations (credit, tikra type, HMO membership). Cannot be split at function boundaries. Strongly recommended for sub-chunking by documenter.",
      "summary": "HandlerToMsg_5003 (5946 lines): Nihul Tikrot (subsidy management) drug sale handler — the largest function in the codebase. Mirrors TR2003 electronic prescription sale logic but adds: subsidy eligibility checks, credit reason handling, tikra type validation, HMO membership verification, subsidy-specific pricing/participation calculation, AS/400 TikrotRPC integration via CallTikrotSP. Includes all validation steps from TR2003 (DUR/OD, purchase limits, health alerts, pharmacy ishur) plus subsidy-specific validation.",
      "tags": ["handler", "trn_5003", "drug_sale", "nihul_tikrot", "subsidy", "core_business_logic", "NEEDS_SUB_CHUNKING", "largest_function"],
      "dependencies": ["ch_sql_020_epr_header"],
      "calls": ["IS_PHARMACY_OPEN_X", "read_member", "read_drug", "test_special_prescription", "test_purchase_limits", "test_interaction_and_overdose", "test_pharmacy_ishur", "test_mac_doctor_drugs_electronic", "CheckHealthAlerts", "CallTikrotSP", "as400EligibilityTest", "update_doctor_presc"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR5003_* (reuses TR2003_5003_* shared operators)", "TikrotRPC.c:CallTikrotSP", "As400UnixMediator.c:as400EligibilityTest"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_025_trn5005",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Transaction 5005: Nihul Tikrot Subsidy Drugs Delivery",
      "line_start": 13611,
      "line_end": 17239,
      "tokens": 12700,
      "tokens_justification": "Two closely related delivery handlers (realtime 1569 lines + spool 2048 lines). Single transaction family that mirrors TR2005 with subsidy-specific additions.",
      "summary": "HandlerToMsg_5005 (13611-15179, 1569 lines): Nihul Tikrot subsidy drugs delivery in realtime mode. Mirrors TR2005 delivery but with subsidy-specific fields. HandlerToSpool_5005 (15192-17239, 2048 lines): same in spooled mode with commfail_flag and recovery logic. Both include AS/400 gadget spool integration and pharmacy daily sum updates.",
      "tags": ["handler", "trn_5005", "delivery", "nihul_tikrot", "subsidy", "realtime_spool_pair"],
      "dependencies": ["ch_sql_020_epr_header", "ch_sql_024_trn5003"],
      "calls": ["DeclareCursor(TR5005_presc_drug_cur)", "ExecSQL(TR5005_UPD_prescription_drugs)", "ExecSQL(TR5005_UPD_prescriptions)", "as400SaveSaleRecord"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR5005_*, TR5005spool_*"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_026_trn2033_6033",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Transactions 2033/6033: Special Recipe (Ishur) Handlers",
      "line_start": 17253,
      "line_end": 18098,
      "tokens": 2960,
      "summary": "GENERIC_HandlerToMsg_2033_6033 (17253-18045, 793 lines): creates/updates pharmacy special recipe authorizations (ishurim). Validates member, checks for existing ishur, handles AS/400 ishur extension, validates specialty largo percentages, writes TR2033_INS_pharmacy_ishur. HandlerToMsg_2033_6033 (18054-18071): thin realtime wrapper. HandlerToSpool_2033_6033 (18080-18098): thin spool wrapper.",
      "tags": ["handler", "trn_2033", "trn_6033", "ishur", "pharmacy_authorization", "template_pattern"],
      "dependencies": ["ch_sql_020_epr_header"],
      "calls": ["IS_PHARMACY_OPEN_X", "read_member", "ExecSQL(TR2033_INS_pharmacy_ishur)", "ExecSQL(TR2033_READ_check_if_ishur_already_used)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR2033_*"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_027_reftbl_2060_2068",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Transactions 2060-2068: Reference Table Downloads",
      "line_start": 18109,
      "line_end": 18997,
      "tokens": 3110,
      "summary": "Five reference table download handlers using common cursor-to-output pattern: HandlerToMsg_2060 (how_to_take), HandlerToMsg_2062 (drug_shape), HandlerToMsg_2064 (unit_of_measure), HandlerToMsg_2066 (reason_not_sold), HandlerToMsg_2068 (discount_remarks). Each ~163-191 lines, reads full table via cursor and formats output.",
      "tags": ["handler", "trn_2060", "trn_2062", "trn_2064", "trn_2066", "trn_2068", "download", "reference_table"],
      "dependencies": ["ch_sql_020_epr_header"],
      "calls": ["DeclareCursor(TR2060_how_to_take_cur)", "DeclareCursor(TR2062_drug_shape_cur)", "DeclareCursor(TR2064_unit_of_measure_cur)", "DeclareCursor(TR2066_reason_not_sold_cur)", "DeclareCursor(TR2068_discount_remarks_cur)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR2060_*-TR2068_*"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_028_update_2070_2084",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Transactions 2070-2084: Data Update/Download Handlers",
      "line_start": 19008,
      "line_end": 21454,
      "tokens": 8560,
      "tokens_justification": "Eight related update/download handlers forming a cohesive data-update section. Splitting would fragment logically related transaction processing.",
      "summary": "Eight data update/download handlers: HandlerToMsg_2070_2092 (economy pricing, handles both Trn 2070 and 2092), HandlerToMsg_2072 (prescription sources), HandlerToMsg_2074 (drug extension simplified), HandlerToMsg_2076 (authorizing authorities), HandlerToMsg_2078 (sale + sale_fp + sale_bonus + sale_target, 503 lines), HandlerToMsg_2080 (gadgets), HandlerToMsg_2082 (PharmDrugNotes incremental), HandlerToMsg_2084 (DrugNotes incremental).",
      "tags": ["handler", "trn_2070", "trn_2072", "trn_2074", "trn_2076", "trn_2078", "trn_2080", "trn_2082", "trn_2084", "data_update", "download"],
      "dependencies": ["ch_sql_020_epr_header"],
      "calls": ["DeclareCursor(TR2070_economypri_cur)", "DeclareCursor(TR2078_sale_cur)", "DeclareCursor(TR2078_sale_bonus_recv_*)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR2070_*-TR2084_*"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_029_recon_2086_2101",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Transactions 2086-2101: Reconciliation, Reporting, Sales Detail",
      "line_start": 21466,
      "line_end": 23519,
      "tokens": 7190,
      "summary": "HandlerToMsg_2086 (260 lines): pharmacy daily summary reconciliation. HandlerToMsg_2088 (753 lines): detailed list of pharmacy drug sales. SALE_compare/DRUG_compare: qsort comparators for sale/drug record sorting. init_package_size_array (143 lines): re-initializes cached drug package sizes from drug_list table. HandlerToMsg_X090 (409 lines): single pharmacy drug sale details, dual-mode handling both Trn 2090 and 5090. HandlerToMsg_2096 (210 lines): usage_instruct table download (Oct 2020). HandlerToMsg_2101 (172 lines): usage_instr_reason_changed table download (Oct 2020).",
      "tags": ["handler", "trn_2086", "trn_2088", "trn_2090", "trn_5090", "trn_2096", "trn_2101", "reconciliation", "reporting"],
      "dependencies": ["ch_sql_020_epr_header"],
      "calls": ["DeclareCursor(TR2086_pharmacy_daily_sum_date_cur)", "DeclareCursor(TR2088_prescriptions_cur)", "DeclareCursor(TR2090_prescription_drugs_cur)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR2086_*-TR2101_*"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_030_reftbl_5051_5061",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Transactions 5051-5061: Nihul Tikrot Reference Table Downloads",
      "line_start": 23531,
      "line_end": 25404,
      "tokens": 6560,
      "summary": "Six Nihul Tikrot reference table download handlers: HandlerToMsg_5051 (credit_reasons), HandlerToMsg_5053 (subsidy_messages), HandlerToMsg_5055 (tikra_type), HandlerToMsg_5057 (hmo_membership), HandlerToMsg_5059 (virtual_store_reason_texts), HandlerToMsg_5061 (druggencomponents — incremental, JSON-capable, added Nov 2025). Each 256-529 lines, common cursor-to-output pattern.",
      "tags": ["handler", "trn_5051", "trn_5053", "trn_5055", "trn_5057", "trn_5059", "trn_5061", "download", "nihul_tikrot", "reference_table"],
      "dependencies": ["ch_sql_020_epr_header"],
      "calls": ["DeclareCursor(TR5051_credit_reasons_cur)", "DeclareCursor(TR5053_subsidy_messages_cur)", "DeclareCursor(TR5055_tikra_type_cur)", "DeclareCursor(TR5057_hmo_membership_cur)", "DeclareCursor(TR5059_virtual_store_reason_texts_cur)", "DeclareCursor(TR5061_DrugGenComponents_cur)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR5051_*-TR5061_*"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_031_epr_utils",
      "file": "source_code/SqlServer/ElectronicPr.c",
      "type": "function",
      "section": "Utility Functions (process_spools, read_member, read_drug)",
      "line_start": 25409,
      "line_end": 26158,
      "tokens": 2625,
      "summary": "process_spools (25409-25681, 273 lines): processes pending AS/400 Gadget spool queue on timed interval, purges old sql_srv_audit rows. FindDrugPurchLimit (25687-25831): [DEAD CODE, #if 0] since 16Nov2025, find purchase-limit rules for a drug. read_member (25838-25888, 51 lines): reads member data into global Member structure (no error handling). read_drug (25897-26158, 262 lines): reads drug data from DrugList into TDrugListRow + TPresDrugs structures.",
      "tags": ["utility", "process_spools", "read_member", "read_drug", "dead_code"],
      "dependencies": ["ch_sql_020_epr_header"],
      "calls": ["DeclareCursor(process_spools_gadget_spool_cur)", "ExecSQL(read_drug_READ_drug_list)", "ExecSQL(READ_members_full)"],
      "called_by": ["ch_sql_004_mainloop", "ch_sql_022_trn2003", "ch_sql_024_trn5003"],
      "cross_refs": ["MacODBC_MyOperators.c:process_spools_*, read_drug_READ_drug_list, READ_members_full"],
      "complexity": "medium"
    },

    {
      "chunk_id": "ch_sql_040_drx_header",
      "file": "source_code/SqlServer/DigitalRx.c",
      "type": "section",
      "section": "Header, Macros, Globals",
      "line_start": 1,
      "line_end": 262,
      "tokens": 790,
      "summary": "File split from ElectronicPr.ec for digital prescription functions. Includes MacODBC.h, MsgHndlr.h, PharmacyErrors.h, MessageFuncs.h, TikrotRPC.h, As400UnixMediator.h. ~30 macros (MACCABI_PHARMACY, FULL_PRICE_SALE, MEMBER_GETS_DISCOUNTS, etc.). Extern declarations for cross-file references (DrugsBuf, MinimumNormalMemberTZ). Forward declarations for process_spools, init_package_size_array, SALE_compare, DRUG_compare. Static array pkg_size[100000].",
      "tags": ["header", "globals", "macros"],
      "dependencies": [],
      "calls": [],
      "called_by": [],
      "cross_refs": ["ElectronicPr.c (forward declarations reference functions defined there)", "MsgHndlr.h"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_041_trn6001_6101",
      "file": "source_code/SqlServer/DigitalRx.c",
      "type": "function",
      "section": "Transactions 6001/6101: Digital Prescription Request",
      "line_start": 273,
      "line_end": 5340,
      "tokens": 17740,
      "tokens_justification": "Single monolithic function HandlerToMsg_6001_6101 (5067 lines) handling the digital prescription request workflow. Supports both transaction 6001 and 6101 (Chanut Virtualit variant). Cannot be split at function boundaries. Recommended for sub-chunking by documenter.",
      "summary": "HandlerToMsg_6001_6101 (5067 lines): retrieves valid digital prescriptions for a member. Supports both TR6001 and TR6101 (Chanut Virtualit variant). Handles JSON and binary modes, doctor visits, drug grouping, online orders. Includes: member validation, pharmacy open check, doctor prescription cursor traversal, drug extension lookups, special prescription testing, participation prediction, preferred drug substitution, ishur availability checking. Returns formatted prescription list with pricing estimates.",
      "tags": ["handler", "trn_6001", "trn_6101", "digital_rx", "prescription_request", "chanut_virtualit", "json_support", "NEEDS_SUB_CHUNKING"],
      "dependencies": ["ch_sql_040_drx_header"],
      "calls": ["IS_PHARMACY_OPEN_X", "read_member", "DeclareCursor(TR6001_doctor_presc_cur)", "test_special_prescription", "FIND_DRUG_EXTENSION", "predict_member_participation", "find_preferred_drug", "SetMemberFlags"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR6001_*, TR6101_*", "MessageFuncs.c (validation functions)"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_042_trn6003",
      "file": "source_code/SqlServer/DigitalRx.c",
      "type": "function",
      "section": "Transaction 6003: Digital Drugs Sale",
      "line_start": 5352,
      "line_end": 13280,
      "tokens": 27750,
      "tokens_justification": "Single monolithic function HandlerToMsg_6003 (7928 lines) — the second-largest function in the codebase. Contains the complete digital prescription drug sale workflow. This is the digital-era equivalent of HandlerToMsg_2003. Cannot be split at function boundaries. STRONGLY recommended for sub-chunking by documenter into phases.",
      "summary": "HandlerToMsg_6003 (7928 lines): the digital prescription drug sale handler ('Mersham Digitali'). The second-largest function in the codebase. Processes actual sale of digitally prescribed drugs including: member/pharmacy validation, drug-by-drug processing loop, pricing/participation calculation, discount logic, Meishar AS/400 integration, bakara kamutit (quantity checking), specialist rules, DUR/overdose checking, purchase limit testing, health alerts, coupon expiry validation, external Rx supplier checking, error/warning assignment, database writes (TR6003_INS_prescription_drugs), doctor prescription updates. Mirrors TR2003 logic but with digital-prescription-specific additions.",
      "tags": ["handler", "trn_6003", "drug_sale", "digital_rx", "core_business_logic", "NEEDS_SUB_CHUNKING", "second_largest_function"],
      "dependencies": ["ch_sql_040_drx_header"],
      "calls": ["IS_PHARMACY_OPEN_X", "read_member", "read_drug", "test_special_prescription", "test_purchase_limits", "test_interaction_and_overdose", "test_pharmacy_ishur", "test_mac_doctor_drugs_electronic", "CheckHealthAlerts", "as400EligibilityTest", "GetParticipatingCode", "ExecSQL(TR6003_INS_prescription_drugs)", "update_doctor_presc"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR6003_*", "MessageFuncs.c (all validation functions)", "As400UnixMediator.c:as400EligibilityTest", "SqlHandlers.c:test_interaction_and_overdose"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_043_trn6005_rt",
      "file": "source_code/SqlServer/DigitalRx.c",
      "type": "function",
      "section": "Transaction 6005: Digital Drugs Delivery (Realtime)",
      "line_start": 13293,
      "line_end": 16308,
      "tokens": 10560,
      "tokens_justification": "Single function HandlerToMsg_6005 (3015 lines) containing the complete digital delivery workflow in realtime mode. Cannot be split at function boundaries.",
      "summary": "HandlerToMsg_6005 (3015 lines): digital prescription drugs delivery in realtime mode. Finalizes a delivery after a 6003 sale: reads prescriptions and prescription drugs via cursors, updates prescription_drugs (35+ SET columns), updates prescriptions, handles prescription vouchers, cannabis product details, pharmacy daily sum, online order validation, AS/400 gadget spool, doctor prescription updates.",
      "tags": ["handler", "trn_6005", "delivery", "digital_rx", "realtime"],
      "dependencies": ["ch_sql_040_drx_header", "ch_sql_042_trn6003"],
      "calls": ["DeclareCursor(TR6005_prescription_drugs_cur)", "ExecSQL(TR6005_UPD_prescription_drugs)", "ExecSQL(TR6005_UPD_prescriptions)", "ExecSQL(TR6005_INS_prescription_vouchers)", "update_doctor_presc", "as400SaveSaleRecord"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR6005_*", "As400UnixMediator.c:as400SaveSaleRecord"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_044_trn6005_spool",
      "file": "source_code/SqlServer/DigitalRx.c",
      "type": "function",
      "section": "Transaction 6005: Digital Drugs Delivery (Spooled)",
      "line_start": 16321,
      "line_end": 19726,
      "tokens": 11920,
      "tokens_justification": "Single function HandlerToSpool_6005 (3405 lines) containing the complete digital delivery workflow in spooled/batch mode. Cannot be split at function boundaries.",
      "summary": "HandlerToSpool_6005 (3405 lines): digital prescription drugs delivery in spooled/batch mode. Same business function as realtime 6005 but designed for deferred processing. Includes commfail_flag parameter, duplicate-spool detection, additional recovery logic. Handles all database operations including INS/UPD for prescription_drugs and prescriptions, pharmacy daily sum, cannabis products, spool-specific validation.",
      "tags": ["handler", "trn_6005", "delivery", "digital_rx", "spool", "batch_mode"],
      "dependencies": ["ch_sql_040_drx_header"],
      "calls": ["DeclareCursor(TR6005spool_deldrugs_cur)", "ExecSQL(TR6005spool_INS_prescription_drugs)", "ExecSQL(TR6005spool_UPD_prescription_drugs)", "update_doctor_presc"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR6005spool_*"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_045_trn6011",
      "file": "source_code/SqlServer/DigitalRx.c",
      "type": "function",
      "section": "Transaction 6011: Member Drug History Download",
      "line_start": 19747,
      "line_end": 21028,
      "tokens": 4490,
      "summary": "HandlerToMsg_6011 (1281 lines): member drug history and ishurim download. Added July 2025 (User Story #417785). Supports six download modes: all sales, all Rx sales, treatment sales, opioid sales, ADHD sales, combined opioid+ADHD. JSON-capable output. Includes doctor visits validation, receipt number checking, prior sale download via complex multi-JOIN query, ishur download.",
      "tags": ["handler", "trn_6011", "drug_history", "digital_rx", "json_support", "download"],
      "dependencies": ["ch_sql_040_drx_header"],
      "calls": ["ExecSQL(TR6011_AreDoctorVisitsAlive)", "DeclareCursor(TR6011_PriorSaleDownload)", "DeclareCursor(TR6011_IshurDownload)", "ExecSQL(TR6011_WriteAudit)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR6011_*"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_046_trn6102_6103",
      "file": "source_code/SqlServer/DigitalRx.c",
      "type": "function",
      "section": "Transactions 6102/6103: Chanut Virtualit + Utility",
      "line_start": 21041,
      "line_end": 22953,
      "tokens": 6700,
      "summary": "HandlerToMsg_6102 (21041-21323, 282 lines): counts valid prescriptions for a list of members (typically a family) for Chanut Virtualit application; JSON-only, smallest handler. HandlerToMsg_6103 (21335-22913, 1578 lines): predicted participation calculation for a group of drugs including Meishar and Nihul Tikrot reductions for Chanut Virtualit; provides price estimates before actual sale. rx_source_found (22916-22953, 37 lines): helper testing whether a specific prescription source exists in a drug sale request.",
      "tags": ["handler", "trn_6102", "trn_6103", "chanut_virtualit", "virtual_pharmacy", "json_only", "utility"],
      "dependencies": ["ch_sql_040_drx_header"],
      "calls": ["IS_PHARMACY_OPEN_X", "read_member", "ExecSQL(TR6102_READ_PrescriptionCount)", "ExecSQL(TR6103_READ_gadgets)", "ExecSQL(TR6103_READ_special_prescs)"],
      "called_by": ["ch_sql_006_dispatch_switch"],
      "cross_refs": ["MacODBC_MyOperators.c:TR6102_*, TR6103_*"],
      "complexity": "high"
    },

    {
      "chunk_id": "ch_sql_050_msgfn_header",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "section",
      "section": "Header, Includes, Globals",
      "line_start": 1,
      "line_end": 98,
      "tokens": 295,
      "summary": "File header (authors: Gilad Haimov, Boaz Shnapp, Ely Levy — Reshuma Ltd., 1996). Includes MacODBC.h, PharmacyErrors.h, MsgHndlr.h, DBFields.h, MessageFuncs.h, TikrotRPC.h. Macros SET_POS, LOG_CONFLICT, Conflict_Test. Defines RIDICULOUS_HIGH_PRICE, PURCHASE_LIMIT_HISTORY_MONTHS. Forward declaration of SUPPLY_compare.",
      "tags": ["header", "globals", "macros"],
      "dependencies": [],
      "calls": [],
      "called_by": [],
      "cross_refs": ["MessageFuncs.h (public API declarations)"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_051_msg_parsing",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Message Parsing + Error/JSON + Date/Time Validation",
      "line_start": 100,
      "line_end": 571,
      "tokens": 1420,
      "summary": "16 low-level functions: Message buffer parsing (AsciiToBin, GetChar, GetShort, GetInt, GetLong, GetString, GetNothing, verify_numeric, get_message_header, WriteErrAndexit). Error/JSON validation (CHECK_JSON_ERROR, PrintErr, ChckInputLen, ChckInputLenAllowTrailingSpaces). Date/time validation (ChckDate: YYYYMMDD range 19800000-20900000; ChckTime: HHNNSS range 0-240000).",
      "tags": ["utility", "message_parsing", "input_validation", "date_time", "json_error"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": [],
      "called_by": ["ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_042_trn6003"],
      "cross_refs": ["PharmDBMsgs.h (wire protocol field definitions)"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_052_tbl_error_infra",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Table Update Check + Error Array Engine",
      "line_start": 587,
      "line_end": 1043,
      "tokens": 1600,
      "summary": "GetTblUpFlg (587-648): checks database table modification date; returns MAC_TRUE if table was updated after pharmacy's last refresh. SetErrorVar_x (650-1043, 394 lines): master error-tracking engine managing error arrays, severity comparison, deduplication. Supports old single-error and new array modes. Called via macros SetErrorVarInit, SetErrorVar, SetErrorVarArr, SetErrorVarDelete, SetErrorVarTell.",
      "tags": ["utility", "error_tracking", "table_update", "infrastructure"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["ExecSQL(READ_TablesUpdate)"],
      "called_by": ["ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_042_trn6003"],
      "cross_refs": ["MacODBC_MyOperators.c:READ_TablesUpdate"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_053_pharmacy_auth",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Pharmacy Open/Authorization Check",
      "line_start": 1057,
      "line_end": 1414,
      "tokens": 1250,
      "summary": "IS_PHARMACY_OPEN_X (1057-1414, 358 lines): tests if pharmacy is open and authorized for the current transaction. Reads from database (not shared memory). Populates PHARMACY_INFO structure with pharmacy type, permissions, Hebrew encoding flag. Handles access-conflict retry with do-while loop. Called by virtually all transaction handlers as the first validation step.",
      "tags": ["utility", "pharmacy_validation", "authorization", "critical_path"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["ExecSQL(IsPharmOpen_READ_pharmacy)", "ExecSQL(IsPharmOpen_READ_pharmacy_type_params)", "ExecSQL(IsPharmOpen_READ_hebrew_encoding)"],
      "called_by": ["ch_sql_011_trn1001", "ch_sql_021_trn2001", "ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_041_trn6001_6101", "ch_sql_042_trn6003"],
      "cross_refs": ["MacODBC_MyOperators.c:IsPharmOpen_*"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_054_drug_interaction",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Drug Interaction Checking + Blood Drug Retrieval",
      "line_start": 1431,
      "line_end": 2195,
      "tokens": 2680,
      "summary": "IS_DRUG_INTERACAT (1431-1514, 84 lines): tests two drugs for interaction via database lookup; returns 0=no change, 1=interaction found, 2=deadlock, 3=error. CheckForInteractionIshur (1519-1754, 236 lines): checks whether doctor approved a drug-drug interaction; looks up doctor prescription IDs, member blood drugs, and interaction approval records. TransactionRestart (1765-1773): rollback current SQL transaction. get_drugs_in_blood (1787-2195, 409 lines): retrieves all drugs currently in member's blood from database; uses static caching (same-member optimization); handles multiple call types and deadlock/restart.",
      "tags": ["utility", "drug_interaction", "blood_drugs", "caching", "deadlock_handling"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["ExecSQL(IsDrugInteract_READ_drug_interaction)", "DeclareCursor(GetDrugsInBlood_blood_drugs_cur)", "RollbackWork"],
      "called_by": ["ch_sql_017_dur_od_engine"],
      "cross_refs": ["MacODBC_MyOperators.c:IsDrugInteract_*, GetDrugsInBlood_*, CheckForInteractionIshur_*"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_055_special_presc",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Special Prescription Validation",
      "line_start": 2201,
      "line_end": 3543,
      "tokens": 4700,
      "summary": "test_special_prescription (2201-3543, 1343 lines): comprehensive validation of special-confirmation prescriptions. Checks dosage limits, refill counts, treatment intervals, usage patterns, multi-source confirmation, doctor authorization, pharmacist override logic. Reads special_prescs table with 15 output columns. Handles partial narcotics prescriptions, same-day same-pharmacy sales, fully/partly sold status. Central validation function called by all sale handlers.",
      "tags": ["utility", "special_prescription", "validation", "business_rules", "core_validation"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["ExecSQL(TestSpecialPresc_READ_special_prescs)", "ExecSQL(TestSpecialPresc_READ_prescription_usage)", "ExecSQL(CheckForPartlySoldDocRx_partly_sold_cur)"],
      "called_by": ["ch_sql_021_trn2001", "ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_041_trn6001_6101", "ch_sql_042_trn6003"],
      "cross_refs": ["MacODBC_MyOperators.c:TestSpecialPresc_*, CheckForPartlySoldDocRx_*, CheckForPartlySoldNarcoticsPrescription"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_056_usage_limits",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Usage Calculation + Purchase Limits",
      "line_start": 3548,
      "line_end": 5283,
      "tokens": 6080,
      "summary": "determine_actual_usage (3548-3863, 316 lines): calculates actual drug usage based on treatment days, ingredient dosing, and available supply units; tracks fully-used/partially-used/discarded units. SUPPLY_compare (3866-3890): qsort comparator for SUPPLY structures by descending per-unit dosage. ReadDrugPurchaseLimData_x (3908-4540, 633 lines): reads drug purchase-limit configuration from database; handles regular and ishur-based limits; populates limit method/quantity/date arrays. test_purchase_limits (4553-5283, 731 lines): tests current sale against purchase-limit rules; checks history over configurable month window; handles 9 limit methods (0-8).",
      "tags": ["utility", "usage_calculation", "purchase_limits", "business_rules"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["DeclareCursor(ReadDrugPurchaseLim_FindDrugPurchLimit_cur)", "ExecSQL(ReadDrugPurchaseLim_READ_purchase_lim_ishur)", "ExecSQL(GetPurchaseLimitClassHistoryLength)"],
      "called_by": ["ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_042_trn6003"],
      "cross_refs": ["MacODBC_MyOperators.c:ReadDrugPurchaseLim_*"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_057_ishur_special",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Pharmacy Ishur + Special Drug Rules",
      "line_start": 5297,
      "line_end": 6223,
      "tokens": 3240,
      "summary": "test_pharmacy_ishur (5297-5822, 526 lines): tests pharmacy-level authorization (ishur) for member drugs; handles '29 gimel' forms, specialist letters, old-age home overrides. check_sale_against_pharm_ishur (5836-6030, 195 lines): checks individual sale lines against pharmacy ishur; populates extended-days and profession arrays. test_special_drugs (6052-6079, 28 lines): loop wrapper calling test_special_drugs_electronic for each drug. test_special_drugs_electronic (6101-6223, 123 lines): validates one drug against special-drug rules (dentist/home-visit); determines participation, price code, health basket.",
      "tags": ["utility", "pharmacy_ishur", "special_drugs", "authorization", "validation"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["ExecSQL(TestPharmacyIshur_READ_pharmacy_ishur)", "DeclareCursor(check_sale_against_pharm_ishur_cur)", "DeclareCursor(TestSpecialDrugs_SLP_cur)"],
      "called_by": ["ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_042_trn6003"],
      "cross_refs": ["MacODBC_MyOperators.c:TestPharmacyIshur_*, TestSpecialDrugs_*"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_058_doctor_pricing",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Doctor-Drug Participation + Pricing Helpers",
      "line_start": 6248,
      "line_end": 7978,
      "tokens": 6060,
      "summary": "test_mac_doctor_drugs_electronic (6248-6873, 626 lines): tests participation percent for Maccabi-doctor drugs; handles specialist letters, old-age home rules, purchase history, preferred-drug swap. predict_member_participation (6889-7282, 394 lines): predicts member participation for prescription-request transactions (TR6001). test_no_presc_drugs (7297-7459, 163 lines): tests participation for OTC drugs. FIND_DRUG_EXTENSION (7475-7555, 81 lines): looks up drug extension record from database. GetParticipatingCode (7566-7744, 179 lines): finds lowest participation code for a drug. SimpleFindLowestPtn (7761-7854, 94 lines): simplified lowest-participation finder. FindLowestPtnForPrescRequest (7871-7978, 108 lines): lowest participation for TR6001.",
      "tags": ["utility", "pricing", "participation", "drug_extension", "doctor_drugs"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["ExecSQL(FIND_DRUG_EXTENSION_row)", "ExecSQL(READ_PriceList_simple)", "DeclareCursor(TestMacDoctorDrugsElectronic_SpecialistPtn_1_cur)"],
      "called_by": ["ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_041_trn6001_6101", "ch_sql_042_trn6003"],
      "cross_refs": ["MacODBC_MyOperators.c:FIND_DRUG_EXTENSION_row, READ_PriceList_*, TestMacDoctorDrugsElectronic_*"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_059_health_alerts",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Health Alert Rules Engine",
      "line_start": 7991,
      "line_end": 9960,
      "tokens": 6890,
      "summary": "SumMemberDrugsUsed (7991-8074, 84 lines): sums total drugs bought by member at reduced cost over given duration; dirty-read isolation. CheckHealthAlerts (8094-9960, 1867 lines): in-memory rules cache engine for health alerts. Refreshes from database periodically. Tests 5 modes: standard, compliance, new-drug, ingredient-count, all-tests. Checks drug interactions against rules. Assigns warning/error codes. Uses 23-column cursor for rule definitions. Second-largest function in MessageFuncs.c.",
      "tags": ["utility", "health_alerts", "rules_engine", "in_memory_cache", "core_validation"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["DeclareCursor(CheckHealthAlerts_HAR_cursor)", "ExecSQL(CheckHealthAlerts_READ_DiagnosisCount)", "ExecSQL(CheckHealthAlerts_READ_MaxIngredientCode)", "ExecSQL(SumMemberDrugsUsed_READ_PD_totals)"],
      "called_by": ["ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_042_trn6003"],
      "cross_refs": ["MacODBC_MyOperators.c:CheckHealthAlerts_*, SumMemberDrugsUsed_*"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_060_doctor_updates",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Doctor Prescription Updates + Late Arrival Queue",
      "line_start": 9969,
      "line_end": 11390,
      "tokens": 4975,
      "summary": "update_doctor_presc (9969-11142, 1174 lines): updates doctor prescription tables after drug sale/deletion; handles carry-forward units, dosage tracking, late-arrival queue insertion, spool-on-failure logic; supports both normal and late-arrival modes; reads Rx by generic group or largo prescribed. ProcessRxLateArrivalQueue (11146-11390, 245 lines): processes queue of late-arriving doctor prescriptions from rx_late_arrival_q table; calls update_doctor_presc for each queued entry with retry logic.",
      "tags": ["utility", "doctor_prescription", "late_arrival", "queue_processing", "carry_forward"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["ExecSQL(UpdateDoctorPresc_READ_Rx_by_Generic_Group)", "ExecSQL(UpdateDoctorPresc_UPD_Rx_std_keys)", "ExecSQL(UpdateDoctorPresc_INS_pd_rx_link)", "DeclareCursor(ProcessRxLateArrivalQ_ProcRxArrivals_cur)"],
      "called_by": ["ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_042_trn6003", "ch_sql_043_trn6005_rt", "ch_sql_044_trn6005_spool"],
      "cross_refs": ["MacODBC_MyOperators.c:UpdateDoctorPresc_*, ProcessRxLateArrivalQ_*"],
      "complexity": "very_high"
    },
    {
      "chunk_id": "ch_sql_061_member_services",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "Member Services (Eligibility, Deletion, Spool Lock, Preferred Drug, Pricing)",
      "line_start": 11394,
      "line_end": 12830,
      "tokens": 5030,
      "summary": "12 functions: CheckForServiceWithoutCard_Old (11394-11555, DEAD CODE #if 0). CheckForServiceWithoutCard (11559-11731): current eligibility via REST service (Apr 2025). CheckMember29G (11734-11853): Form 29-G validation. CheckForPartiallySoldDoctorPrescription (11857-11923): partial sale check. MarkDeleted (11927-12073): marks prescription/drug line as deleted with access-conflict retry. GetSpoolLock/ClearSpoolLock (12077-12191): spool lock acquire/release. is_valid_presc_source (12195-12236): validates prescription source code. find_preferred_drug (12238-12526, 289 lines): finds generic substitution drug with purchase history check. MemberFailedToPickUpDrugs (12530-12590): no-show history check. read_member_price (12599-12704): member price table with 15-minute cache. SetMemberFlags (12713-12830): derives member flags from database record.",
      "tags": ["utility", "member_services", "eligibility", "deletion", "spool_lock", "preferred_drug", "member_pricing", "dead_code"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["EligibilityWithoutCard", "ExecSQL(CheckMember29G_READ_member_drug_29g)", "ExecSQL(MarkDrugSaleDeleted_UPD_prescription_drugs)", "ExecSQL(GetSpoolLock_INS_pharm_spool_lock)", "DeclareCursor(find_preferred_drug_drugforms_cur)", "DeclareCursor(READ_member_price_cur)"],
      "called_by": ["ch_sql_022_trn2003", "ch_sql_024_trn5003", "ch_sql_041_trn6001_6101", "ch_sql_042_trn6003"],
      "cross_refs": ["MacODBC_MyOperators.c:CheckMember29G_*, MarkDrugSaleDeleted_*, GetSpoolLock_*, find_preferred_drug_*, READ_member_price_cur"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_062_rest_integration",
      "file": "source_code/SqlServer/MessageFuncs.c",
      "type": "function",
      "section": "REST Service Integration (CURL)",
      "line_start": 12833,
      "line_end": 13631,
      "tokens": 2800,
      "summary": "6 functions: TranslateTechnicalID (12833-12958): translates technical member ID to TZ (Israeli national ID) via REST service with cached initialization. EligibilityWithoutCard (12962-13149): checks member eligibility without card via REST service (Apr 2025); parses JSON approval-type, valid-from/valid-to. set_up_consumed_REST_service (13154-13392): initializes REST_SERVICE structure from database template; extracts URL components. consume_REST_service (13395-13568): executes REST call via CURL; builds URL, sets headers, manages output buffer. REST_CurlMemoryCallback (13571-13612, static): CURL write callback. REST_CurlMemoryClear (13616-13631, static): resets REST buffer.",
      "tags": ["utility", "rest_api", "curl", "member_eligibility", "json_parsing"],
      "dependencies": ["ch_sql_050_msgfn_header"],
      "calls": ["curl_easy_init", "curl_easy_setopt", "curl_easy_perform", "cJSON_Parse", "ExecSQL(READ_service_url_components)", "ExecSQL(READ_service_http_headers)"],
      "called_by": ["ch_sql_061_member_services"],
      "cross_refs": ["MacODBC_MyOperators.c:READ_service_url_components, READ_service_http_headers", "libcurl", "cJSON"],
      "complexity": "medium"
    },

    {
      "chunk_id": "ch_sql_070_ops_header",
      "file": "source_code/SqlServer/MacODBC_MyOperators.c",
      "type": "section",
      "section": "Header + GenSql Include Seam",
      "line_start": 1,
      "line_end": 87,
      "tokens": 220,
      "summary": "Documentation comment block explaining all settable variables (SQL_CommandText, NumOutputColumns, NumInputColumns, NumWhereColumns, CommandIsMirrored, CommandIsSticky, WhereClause). Line 87: #include \"GenSql_ODBC_Operators.c\" — include seam injecting shared GenSql operator definitions before component-specific operators.",
      "tags": ["header", "include_injection", "documentation"],
      "dependencies": [],
      "calls": [],
      "called_by": [],
      "cross_refs": ["MacODBC.h:SQL_GetMainOperationParameters (injection point at line 2747)", "GenSql_ODBC_Operators.c (shared operators)"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_071_ops_general",
      "file": "source_code/SqlServer/MacODBC_MyOperators.c",
      "type": "section",
      "section": "General/Shared Operators (118 active cases)",
      "line_start": 89,
      "line_end": 4185,
      "tokens": 14340,
      "tokens_justification": "118 active operator case definitions (plus 2 commented out) forming a single cohesive switch-case section. These are cross-transaction utility operators used across multiple handlers. Splitting would fragment the logical grouping. Includes 2 dynamic-SQL holes where SQL_CommandText=NULL.",
      "summary": "118 active operator case definitions used across multiple transaction handlers. Key operator groups: CheckHealthAlerts_* (23 operators for health alert rules engine), GetDrugsInBlood_* (blood drug retrieval), IsPharmOpen_* (pharmacy validation), LoadPrescSourceCur/LoadTrnPermitCur (cache loaders), MarkDrugSaleDeleted_* (deletion), ReadDrugPurchaseLim_* (purchase limits), TestMacDoctorDrugsElectronic_* (doctor drug pricing), TestPharmacyIshur_* (ishur validation), TestSpecialPresc_* (special prescription), UPD_* (audit/status updates), UpdateDoctorPresc_* (doctor prescription). INS_prescriptions has 63 input columns. DYNAMIC SQL HOLES: CheckForInteractionIshur_READ_IshurCount at line 4182 (SQL_CommandText=NULL, built at runtime).",
      "tags": ["operators", "general", "shared", "cross_transaction", "dynamic_sql"],
      "dependencies": ["ch_sql_070_ops_header"],
      "calls": [],
      "called_by": ["ch_sql_053_pharmacy_auth", "ch_sql_054_drug_interaction", "ch_sql_055_special_presc", "ch_sql_056_usage_limits", "ch_sql_057_ishur_special", "ch_sql_058_doctor_pricing", "ch_sql_059_health_alerts", "ch_sql_060_doctor_updates", "ch_sql_061_member_services"],
      "cross_refs": ["MacODBC.h:SQL_GetMainOperationParameters (these cases are injected at line 2747)", "MacODBC_MyOperatorIDs.h (enum values for each operator)"],
      "complexity": "high",
      "dynamic_sql_operators": ["CheckForInteractionIshur_READ_IshurCount (line 4182)"]
    },
    {
      "chunk_id": "ch_sql_072_ops_tr1xxx",
      "file": "source_code/SqlServer/MacODBC_MyOperators.c",
      "type": "section",
      "section": "TR1xxx Operators (23 cases)",
      "line_start": 4188,
      "line_end": 4685,
      "tokens": 1740,
      "summary": "23 operator case definitions for 1xxx transactions. Key operators: TR1001_INS_pharmacy_log (43 input cols), TR1001_READ_Pharmacy, TR1011_2094_DrugListDownload_cur (shared cursor for drug list), TR1013_INS_pharmacy_log, TR1014_PriceList_cur, TR1022_INS_Stock/StockReport, TR1026 message cursors, TR1028_READ_PharmacyDailySum, TR1043/1047/1049/1051 download cursors, TR1053_INS_money_empty/lines, TR1055 DUR/OD cursors, TR1080_pharmacy_contract_cur.",
      "tags": ["operators", "tr1xxx", "pharmacy_management"],
      "dependencies": ["ch_sql_070_ops_header"],
      "calls": [],
      "called_by": ["ch_sql_011_trn1001", "ch_sql_012_trn1011_1014", "ch_sql_013_trn1022_1028", "ch_sql_014_trn1043_1051", "ch_sql_015_trn1053_1055", "ch_sql_016_trn1080_wrappers"],
      "cross_refs": ["MacODBC_MyOperatorIDs.h (TR1xxx enum values)"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_073_ops_tr2xxx",
      "file": "source_code/SqlServer/MacODBC_MyOperators.c",
      "type": "section",
      "section": "TR2xxx Operators (50 cases)",
      "line_start": 4686,
      "line_end": 6002,
      "tokens": 4610,
      "summary": "50 operator case definitions for electronic prescription transactions. Key operators: TR2001_Rx_cursor (doctor_presc join), TR2003_INS_prescription_drugs/prescriptions, TR2003_5003_READ_doctor_presc (shared), TR2005 realtime cursors and UPD statements, TR2005spool INS/UPD variants, TR2033 ishur operators, TR2060-2068 reference table cursors, TR2070-2084 data download cursors, TR2086-2101 reconciliation/reporting operators. DYNAMIC SQL HOLE: TR2088_prescription_drugs_cur at line 5820 (SQL_CommandText=NULL, generated dynamically).",
      "tags": ["operators", "tr2xxx", "electronic_rx", "dynamic_sql"],
      "dependencies": ["ch_sql_070_ops_header"],
      "calls": [],
      "called_by": ["ch_sql_021_trn2001", "ch_sql_022_trn2003", "ch_sql_023_trn2005", "ch_sql_026_trn2033_6033", "ch_sql_027_reftbl_2060_2068", "ch_sql_028_update_2070_2084", "ch_sql_029_recon_2086_2101"],
      "cross_refs": ["MacODBC_MyOperatorIDs.h (TR2xxx enum values)"],
      "complexity": "medium",
      "dynamic_sql_operators": ["TR2088_prescription_drugs_cur (line 5820)"]
    },
    {
      "chunk_id": "ch_sql_074_ops_tr5xxx",
      "file": "source_code/SqlServer/MacODBC_MyOperators.c",
      "type": "section",
      "section": "TR5xxx Operators (19 cases)",
      "line_start": 6004,
      "line_end": 6566,
      "tokens": 1970,
      "summary": "19 operator case definitions for Nihul Tikrot (credit/return/cancellation) transactions. Key operators: TR5003_deldrugs_cur, TR5003_INS_prescription_drugs (69 input columns — largest INSERT in the file), TR5003_READ_prescription_drugs_rows_to_delete, TR5005 realtime cursors and UPD statements, TR5005spool INS/UPD variants, TR5051-5061 reference table download cursors (credit_reasons, subsidy_messages, tikra_type, hmo_membership, virtual_store_reason_texts, druggencomponents).",
      "tags": ["operators", "tr5xxx", "nihul_tikrot", "subsidy"],
      "dependencies": ["ch_sql_070_ops_header"],
      "calls": [],
      "called_by": ["ch_sql_024_trn5003", "ch_sql_025_trn5005", "ch_sql_030_reftbl_5051_5061"],
      "cross_refs": ["MacODBC_MyOperatorIDs.h (TR5xxx enum values)"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_075_ops_tr6xxx",
      "file": "source_code/SqlServer/MacODBC_MyOperators.c",
      "type": "section",
      "section": "TR6xxx Operators + Tail Utilities (55 cases)",
      "line_start": 6568,
      "line_end": 8418,
      "tokens": 6480,
      "summary": "52 TR6xxx operator case definitions for digital prescription transactions plus 3 tail utility operators. Key operators: TR6001_doctor_presc_cur (18+ output cols, large cursor), TR6001_doctor_presc_cur_simplified (alternate version), TR6001 validation operators (ishur, discount, prior purchase checks), TR6003_INS_prescription_drugs (large INSERT), TR6005_UPD_prescription_drugs (35+ SET columns — largest UPDATE), TR6005spool variants, TR6011 history download operators (PriorSaleDownload is 163-line multi-JOIN — largest single operator). Tail: READ_Rx_DoctorRuleNumber, READ_service_url_components, READ_service_http_headers.",
      "tags": ["operators", "tr6xxx", "digital_rx", "chanut_virtualit", "tail_utilities"],
      "dependencies": ["ch_sql_070_ops_header"],
      "calls": [],
      "called_by": ["ch_sql_041_trn6001_6101", "ch_sql_042_trn6003", "ch_sql_043_trn6005_rt", "ch_sql_044_trn6005_spool", "ch_sql_045_trn6011", "ch_sql_046_trn6102_6103", "ch_sql_062_rest_integration"],
      "cross_refs": ["MacODBC_MyOperatorIDs.h (TR6xxx enum values)"],
      "complexity": "medium"
    },

    {
      "chunk_id": "ch_sql_080_socketapi_h",
      "file": "source_code/SqlServer/SocketAPI.h",
      "type": "section",
      "section": "Socket API Header",
      "line_start": 1,
      "line_end": 47,
      "tokens": 140,
      "summary": "Typedefs: CINT, PBYTE, PINT, PCHAR, BOOL. Function prototypes: SocketCreate, SocketReceive, SocketSend, SocketConnect, GetAddress. Defines the TCP socket wrapper API used by all network communication in SqlServer.",
      "tags": ["header", "socket", "tcp", "infrastructure"],
      "dependencies": [],
      "calls": [],
      "called_by": [],
      "cross_refs": ["SocketAPI.c (implementation)"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_081_socketapi_c",
      "file": "source_code/SqlServer/SocketAPI.c",
      "type": "function",
      "section": "Socket API Implementation",
      "line_start": 1,
      "line_end": 265,
      "tokens": 930,
      "summary": "TCP socket wrapper implementation. SocketCreate: AF_INET/SOCK_STREAM with SO_REUSEADDR+SO_KEEPALIVE. SocketReceive: select()-based recv with configurable timeout. SocketSend: select()-based send loop handling partial writes. SocketConnect: connect with timeout via select. GetAddress: gethostbyname with inet_addr fallback (deprecated API). Dependencies: Global.h, DebugPrint.h, SocketAPI.h, GerrLogMini.",
      "tags": ["infrastructure", "socket", "tcp", "select_based", "deprecated_api"],
      "dependencies": ["ch_sql_080_socketapi_h"],
      "calls": ["socket", "setsockopt", "select", "recv", "send", "connect", "gethostbyname"],
      "called_by": ["ch_sql_085_as400med_c"],
      "cross_refs": ["As400UnixMediator.c (primary user)", "SqlServer.c:GetSocketMessage/WriteSocket"],
      "complexity": "medium"
    },
    {
      "chunk_id": "ch_sql_082_debugprint",
      "file": "source_code/SqlServer/DebugPrint.c",
      "type": "function",
      "section": "Debug Print Utility",
      "line_start": 1,
      "line_end": 105,
      "tokens": 315,
      "summary": "Guarded by #ifdef __DEBUG_PRINT__. DebugPrint(): va_list + vsprintf into char[10000] — BUFFER OVERFLOW RISK [NEEDS_VERIFICATION] (no bounds checking on format string output). FileSubDirDateStamp(): generates date-stamped filename for debug log. SetDebugFileName(): configures debug output file path.",
      "tags": ["utility", "debug", "logging", "buffer_overflow_risk", "NEEDS_VERIFICATION"],
      "dependencies": [],
      "calls": ["vsprintf", "fopen", "fprintf"],
      "called_by": [],
      "cross_refs": [],
      "complexity": "low",
      "verification_items": ["vsprintf into char[10000] without bounds checking — potential buffer overflow if format string produces >10000 chars"]
    },
    {
      "chunk_id": "ch_sql_083_tikrotrpc",
      "file": "source_code/SqlServer/TikrotRPC.c",
      "type": "function",
      "section": "Nihul Tikrot RPC (DB2 Stored Procedure)",
      "line_start": 1,
      "line_end": 494,
      "tokens": 1730,
      "summary": "CallTikrotSP(): calls DB2 stored procedure 'RKPGMPRD.TIKROT' with 8 parameters (4 in, 4 out). Retry-with-recursion on SQL_ERROR (500ms sleep between retries). InitTikrotSP(): public initialization shell. RPC_Initialize(): uses deprecated ODBC APIs (SQLAllocEnv, SQLAllocConnect, SQLAllocStmt), reads /pharm/bin/NihulTikrot.cfg for DSN selection (ASTEST vs AS400), SQLConnect, SQLPrepare, 3-second query timeout. RPC_Cleanup(): full resource cleanup. TestTikraCall(): test function with dummy data.",
      "tags": ["infrastructure", "rpc", "db2", "stored_procedure", "nihul_tikrot", "deprecated_api", "as400", "NEEDS_VERIFICATION"],
      "dependencies": [],
      "calls": ["SQLAllocEnv", "SQLAllocConnect", "SQLConnect", "SQLPrepare", "SQLExecute", "SQLBindParameter"],
      "called_by": ["ch_sql_024_trn5003"],
      "cross_refs": ["AS/400 DB2 stored procedure RKPGMPRD.TIKROT"],
      "complexity": "high",
      "verification_items": ["Uses deprecated ODBC 2.x APIs (SQLAllocEnv, SQLAllocConnect, SQLAllocStmt) instead of ODBC 3.x equivalents", "Config file path /pharm/bin/NihulTikrot.cfg hardcoded"]
    },
    {
      "chunk_id": "ch_sql_084_as400med_h",
      "file": "source_code/SqlServer/As400UnixMediator.h",
      "type": "section",
      "section": "AS/400 Mediator Header",
      "line_start": 1,
      "line_end": 153,
      "tokens": 460,
      "summary": "Constants: SERVER='AS400', PORT=9400, RECV_TIMEOUT=10, SEND_TIMEOUT=4, TRY_TIMEOUT=100ms. Enums: FUNCTION_NUM (SALE=0, ELIGIBILITY=1, DELETE_SALE=2, SALE_STATUS_CHECK=3), ACTION_TYPE, RETURN_CODE (values 0-14), MISHUR_ERROR_CODE (values 0-8). Function prototypes: as400EligibilityTest, as400SaveSaleRecord, ParseString.",
      "tags": ["header", "as400", "meishar", "tcp_client", "constants", "enums"],
      "dependencies": [],
      "calls": [],
      "called_by": [],
      "cross_refs": ["As400UnixMediator.c (implementation)"],
      "complexity": "low"
    },
    {
      "chunk_id": "ch_sql_085_as400med_c",
      "file": "source_code/SqlServer/As400UnixMediator.c",
      "type": "function",
      "section": "AS/400 Mediator Implementation",
      "line_start": 1,
      "line_end": 660,
      "tokens": 2310,
      "summary": "as400EligibilityTest(): TCP client to AS/400 'Meishar' system — builds semicolon-delimited request, connects via SocketAPI, retries with nap(), parses response via ParseString(). Returns eligibility result with error codes. ParseString(): semicolon-delimited response parser using strchr/strncpy/atol/atoi, extracts 30+ fields. as400SaveSaleRecord(): similar TCP client for saving sale records to AS/400. Error suppression: 180-second window for connection failure logging, suppresses alerts between 23:00-01:00 (maintenance window).",
      "tags": ["infrastructure", "as400", "meishar", "tcp_client", "eligibility", "sale_record", "error_suppression"],
      "dependencies": ["ch_sql_084_as400med_h", "ch_sql_081_socketapi_c"],
      "calls": ["SocketCreate", "SocketConnect", "SocketSend", "SocketReceive", "ParseString", "nap"],
      "called_by": ["ch_sql_022_trn2003", "ch_sql_023_trn2005", "ch_sql_024_trn5003", "ch_sql_025_trn5005", "ch_sql_042_trn6003", "ch_sql_043_trn6005_rt"],
      "cross_refs": ["SocketAPI.c (socket wrapper)", "AS/400 Meishar system (external)"],
      "complexity": "high"
    },
    {
      "chunk_id": "ch_sql_086_customwhere",
      "file": "source_code/SqlServer/MacODBC_MyCustomWhereClauses.c",
      "type": "section",
      "section": "Custom WHERE Clause Fragments",
      "line_start": 1,
      "line_end": 274,
      "tokens": 960,
      "summary": "Switch case fragments injected into MacODBC.h's SQL_GetWhereClauseParameters at line 2866. Key cases: CheckForServiceWithoutCard (member sales count), ChooseNewlyUpdatedRows (incremental sync), Find_diagnosis_from_member_diagnoses/special_prescs (diagnosis lookups), Largo_99997_ishur_standard (standard ishur check), READ_PriceList_800_conditional (conditional pricing), TestPharmacyIshur (pharmacy authorization), TestSpecialPresc (special prescription conditions), TR1014 (price list WHERE), TR2001 (prescription drugs WHERE), TR2003_5003 (sale WHERE), TR2090 (sale detail WHERE).",
      "tags": ["operators", "where_clauses", "include_injection", "sql_fragments"],
      "dependencies": [],
      "calls": [],
      "called_by": [],
      "cross_refs": ["MacODBC.h:SQL_GetWhereClauseParameters (injection point at line 2866)", "MacODBC_MyOperatorIDs.h (WhereClause enum values)"],
      "complexity": "medium"
    }
  ]
}
