# Chunker Output - Instructions for Documenter

**Generated by:** CIDRA Chunker Agent (CH)
**Task ID:** CH-SHRINK-001
**Date:** 2026-02-03
**Status:** COMPLETE

---

## Run Information

| Metric | Value |
|--------|-------|
| Component | ShrinkPharm |
| Chunks Created | 4 |
| Total Lines | 600 (574 source + 26 build) |
| Total Files | 4 |
| Language | C |
| Strategy | File-level (small component) |

---

## Key Findings

### System Role
- **ShrinkPharm is a standalone DB housekeeping utility** - NOT a long-running server
- Stated purpose: "ODBC equivalent of ShrinkDoctor for MS-SQL Pharmacy application" (`ShrinkPharm.c:7-10`)
- Does NOT use `InitSonProcess()` bootstrap - connects directly via `SQLMD_connect`

### What It "Shrinks"
- Purges old rows from target database tables based on date retention policy
- Configuration stored in `shrinkpharm` control table (enabled rows where `purge_enabled <> 0`)
- Each control row specifies: `table_name`, `date_column_name`, `days_to_retain`, `commit_count`

### Purge Algorithm
1. Read config from `shrinkpharm` table
2. For each target table: `MinDateToRetain = SysDate - days_to_retain`
3. SELECT rows where `date_column < MinDateToRetain`
4. DELETE each row using `WHERE CURRENT OF ShrinkPharmSelCur`
5. COMMIT every `commit_count` rows
6. UPDATE `shrinkpharm` with run statistics

### Database Configuration
- `LOCK_TIMEOUT = 1000` ms (patient)
- `DEADLOCK_PRIORITY = -2` (below normal - privilege real-time operations)
- `ODBC_PRESERVE_CURSORS = 1` (preserve cursors after COMMIT)

---

## Chunk Index

| Chunk ID | File | Lines | Summary |
|----------|------|-------|---------|
| ch_shrink_001_globals_main | ShrinkPharm.c | 1-359 | Globals + main(): DB connect, read config, purge loop, statistics |
| ch_shrink_002_terminate_handler | ShrinkPharm.c | 363-431 | Signal handler for SIGFPE/SIGSEGV/SIGTERM |
| ch_shrink_003_odbc_operators | MacODBC_MyOperators.c | 1-133 | 5 SQL operator definitions for shrinkpharm operations |
| ch_shrink_004_build | Makefile | 1-26 | Unix build configuration |

---

## Recommended Documentation Order

1. **Start with main() and globals** (ch_shrink_001_globals_main)
   - Understand the purge algorithm and DB configuration

2. **Document ODBC operators** (ch_shrink_003_odbc_operators)
   - SQL cursor definitions and control table schema

3. **Document signal handling** (ch_shrink_002_terminate_handler)
   - Error recovery and graceful shutdown

4. **Document build process** (ch_shrink_004_build)
   - Compilation and linking

---

## Cross-References

### External Dependencies

| Library | Key Functions | Purpose |
|---------|---------------|---------|
| GenLib | `GetDate`, `GetTime`, `IncrementDate`, `strip_spaces` | Date/time utilities |
| GenLib | `GerrLogFnameMini`, `GerrLogReturn`, `ExitSonProcess` | Logging and process exit |
| GenSql | `SQLMD_connect`, `SQLMD_disconnect` | DB connection |
| GenSql | `DeclareAndOpenCursorInto`, `FetchCursor`, `CloseCursor` | Cursor operations |
| GenSql | `ExecSQL`, `FreeStatement`, `CommitAllWork`, `RollbackAllWork` | SQL execution |
| GenSql | `SQLERR_error_test`, `SQLERR_code_cmp` | Error handling |

### Database Tables

| Table | Type | Columns Used |
|-------|------|--------------|
| shrinkpharm | Control | table_name, days_to_retain, date_column_name, use_where_clause, commit_count, purge_enabled, last_run_date, last_run_time, last_run_num_purged |
| (dynamic) | Target | Determined by shrinkpharm.table_name |

### Related Components

- **FatherProcess** - Uses same SQLMD_connect retry pattern
- **SqlServer** - Comments explicitly note ShrinkPharm as suitable for ODBC_PRESERVE_CURSORS
- **As400UnixClient** - Also noted as suitable for ODBC_PRESERVE_CURSORS

---

## Warnings and Notes

### Code Quality Issues
- **Copy-paste artifact:** `TerminateHandler` logs "As400UnixServer" instead of "ShrinkPharm" (`ShrinkPharm.c:388-390, 426-429`)
- **Unused globals:** `need_rollback`, `recs_to_commit`, `recs_committed` declared but never used
- **NULL pointer risk:** `getenv("MAC_LOG")` used without NULL check (`ShrinkPharm.c:72`)

### Security Considerations
- Dynamic SQL built from `shrinkpharm` table values (`table_name`, `date_column_name`)
- If control table is compromised, arbitrary tables could be purged
- Document this risk but do NOT copy actual table/column names from production

### Anti-Hallucination
- All line numbers verified against actual source
- Function boundaries confirmed by reading the code
- Research context from `RESEARCH/ShrinkPharm_deepdive.md` cross-referenced
- Do NOT invent functions, tables, or features not present in the chunks

---

## Research Context

**IMPORTANT:** Read `RESEARCH/ShrinkPharm_deepdive.md` before documenting!

This file contains:
- Detailed analysis of purge logic
- SQL operator definitions with exact citations
- Cross-references to FatherProcess and other components
- Security/robustness notes

---

## Files Reference

```
CHUNKS/ShrinkPharm/
├── repository.json           # All 4 chunks with full metadata
├── graph.json                # Dependency and call relationships
├── analysis.json             # Codebase statistics and findings
├── run_manifest.json         # Execution metadata (this run)
└── DOCUMENTER_INSTRUCTIONS.md # This file
```

---

## Next Steps for Documenter

1. Read `RESEARCH/ShrinkPharm_deepdive.md` for detailed context
2. Read `repository.json` to access chunk content and metadata
3. Read `graph.json` to understand relationships
4. Read `analysis.json` for statistics and key findings
5. Follow the recommended documentation order above
6. Generate 7-file documentation set per CIDRA standards
7. Achieve 100/100 validation score

---

*Generated by CIDRA Chunker Agent*
*Task CH-SHRINK-001 COMPLETE*
