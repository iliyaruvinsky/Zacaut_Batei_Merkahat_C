# FatherProcess - מפרט התוכנית

**רכיב**: FatherProcess
**מזהה משימה**: DOC-FATHER-001
**תאריך יצירה**: 2026-02-02
**מקור**: `source_code/FatherProcess/`

---

## סקירה כללית

על פי כותרת הקובץ ב-`FatherProcess.c:7-10`, FatherProcess מתואר כ:
> "שרת להפעלת מערכת מכבי ולשמירה על כל השרתים פעילים. שרתים להפעלה ופרמטרים נקראים ממסד הנתונים."

נראה כי תוכנית זו מתפקדת כדימון (daemon) מפקח/שומר (watchdog) עבור מערכת הבריאות של מכבי.

**מחבר**: Ely Levy (רשומה), כמצוין ב-`FatherProcess.c:18-19`
**תאריך מקורי**: 30.05.1996

---

## מטרה

על בסיס ניתוח הקוד, נראה כי FatherProcess:

1. **מאתחל משאבי מערכת** - יוצר סמפורים, זיכרון משותף וטבלאות (שורות 303-334)
2. **מפעיל תהליכי בן** - מפעיל תוכניות שרת מוגדרות מפרמטרי מסד הנתונים (שורה 445)
3. **מנטר תהליכי בן** - לולאת שמירה מזהה תהליכים שמתו ומפעילה אותם מחדש (שורות 471-1321)
4. **מטפל בפקודות IPC** - מקבל הודעות בקרה דרך סוקטי Unix-domain (שורות 1104-1198)
5. **מנהל כיבוי מסודר** - מסיים את כל תהליכי הבן באות SIGTERM (שורות 1322-1469)

---

## מבנה קבצים

| קובץ | שורות | מטרה |
|------|------:|------|
| FatherProcess.c | 1972 | קוד מקור ראשי של דימון השמירה |
| MacODBC_MyOperators.c | 114 | הגדרות סמנים (cursors) של ODBC SQL |
| MacODBC_MyCustomWhereClauses.c | 10 | פסוקיות WHERE מותאמות (קובץ stub) |
| Makefile | 44 | תצורת בנייה |
| **סה"כ** | **2140** | |

*ספירת שורות אומתה באמצעות PowerShell `(Get-Content file).Count`*

---

## פונקציות

| פונקציה | שורות | מיקום | מטרה |
|---------|------:|-------|------|
| main | 1324 | 146-1469 | נקודת כניסה, אתחול ולולאת שמירה |
| sql_dbparam_into_shm | 117 | 1481-1597 | טעינת פרמטרים ממסד הנתונים לזיכרון משותף |
| SqlGetParamsByName | 150 | 1608-1757 | קבלת פרמטרים ממסד הנתונים לפי שם תוכנית |
| run_system | 119 | 1766-1884 | הפעלת תהליכי בן מטבלת הפרמטרים |
| GetProgParm | 34 | 1893-1926 | חיפוש פרמטר בודד מהזיכרון המשותף |
| TerminateHandler | 36 | 1937-1972 | מטפל אותות עבור SIGTERM/SIGFPE/SIGSEGV |
| **סה"כ פונקציות** | **6** | | |

---

## תלויות (#include)

על פי שורות 29-30 ב-`FatherProcess.c`:

| קובץ כותרת | שורה | מטרה |
|------------|------|------|
| `<MacODBC.h>` | 29 | שכבת תשתית מסד נתונים ODBC |
| `"MsgHndlr.h"` | 30 | הגדרות טיפול בהודעות (סוגי נתוני T-SWITCH) |

הערה: `MacODBC.h` כולל טרנזיטיבית את `GenSql.h` ו-`Global.h`, המספקים את מנוע טבלאות הזיכרון המשותף, סוגי תהליכים וקבועי מערכת.

---

## הגדרות פרה-פרוססור

על פי שורות 23-76 ב-`FatherProcess.c`, ההגדרות הבאות קיימות:

| הגדרה | שורה | ערך/מטרה |
|-------|------|----------|
| MAIN | 23 | מסמן זהו קובץ התוכנית הראשי |
| FATHER | 24 | מסמן זהו FatherProcess |
| NO_PRN | 25 | מבטל הדפסות אבחון |
| prn | 34/50 | מאקרו הדפסת אבחון |
| prn_1 | 38/53 | הדפסת אבחון עם ארגומנט אחד |
| prn_2 | 44/59 | הדפסת אבחון עם שני ארגומנטים |
| Conflict_Test | 67 | מאקרו בדיקת קונפליקט SQL |
| PROG_KEY_LEN | 74 | ערך: 31 |
| PARAM_NAM_LEN | 75 | ערך: 31 |
| PARAM_VAL_LEN | 76 | ערך: 31 |

סה"כ: 13 הצהרות `#define` (אומת באמצעות PowerShell)

---

## משתנים גלובליים

על פי שורות 78-136 ב-`FatherProcess.c`:

### מצביעי TABLE (שורות 78-94)
| משתנה | מטרה |
|-------|------|
| parm_tablep | טבלת פרמטרים |
| proc_tablep | טבלת רישום תהליכים |
| updt_tablep | חותמות זמן עדכון טבלאות |
| stat_tablep | טבלת סטטוס מערכת |
| tstt_tablep | טבלת סטטיסטיקות בית מרקחת |
| dstt_tablep | טבלת סטטיסטיקות רופאים |
| prsc_tablep | טבלת מרשמים |
| msg_recid_tablep | טבלת מזהי רשומות הודעות |
| dipr_tablep | טבלת תהליכים שמתו |

### משתנים גלובליים אחרים (שורות 97-136)
| משתנה | סוג | שורה | מטרה |
|-------|-----|------|------|
| table_ptrs | TABLE**[] | 97 | מפה אינדקסי טבלאות למצביעים |
| InstanceControl | TInstanceControl[] | 122 | מערך בקרת תוכניות מרובות מופעים |
| running_system | int | 128 | מפת סיביות של תת-מערכות פעילות |
| caught_signal | int | 130 | מספר האות שנתפס לכיבוי |
| TikrotProductionMode | int | 131 | מונע שגיאות external לא פתורות |
| UseODBC | int | 132 | דגל שימוש ב-ODBC (תמיד 1) |
| sig_act_terminate | struct sigaction | 136 | תצורת מטפל SIGTERM |

---

## ממשק שורת פקודה

על פי שורות 13-15 ב-`FatherProcess.c`:

```
שימוש: FatherProcess.exe
```

התוכנית לא מקבלת ארגומנטי שורת פקודה. כל התצורה נקראת מ:
1. משתני סביבה (לדוגמה, `MAC_SYS` בשורה 409)
2. טבלת `setup_new` במסד הנתונים (דרך `SqlGetParamsByName` בשורה 277)

---

## קודי יציאה

על בסיס הצהרת switch בשורות 858-965, נראה כי קודי היציאה הבאים מזוהים:

| קוד | קבוע | משמעות |
|-----|------|--------|
| 0 | MAC_SERV_SHUT_DOWN | כיבוי רגיל |
| - | MAC_SYST_SHUT_DOWN | כיבוי מערכת |
| - | MAC_EXIT_NO_MEM | שגיאת זיכרון |
| - | MAC_EXIT_SQL_ERR | שגיאת SQL |
| - | MAC_EXIT_SQL_CONNECT | שגיאת התחברות SQL |
| - | MAC_EXIT_SELECT | שגיאת מערכת |
| - | MAC_EXIT_TCP | שגיאת רשת |
| - | MAC_EXIT_SIGNAL | הופסק על ידי אות שנלכד |
| - | MAC_CHILD_NOT_STARTED | תהליך בן נכשל בהפעלה |
| - | MAC_SERV_RESET | התבקש איפוס שרת |

התוכנית עצמה יוצאת עם `MAC_OK` בשורה 1464.

---

## מגבלות התיעוד

### מה לא ניתן לקבוע מהקוד:
- תכולת טבלת מסד הנתונים `setup_new` בפועל
- התנהגות זמן ריצה תחת תנאי עומס ספציפיים
- רשימה מלאה של תוכניות בן שעשויות לפעול (תלוי בתצורת מסד הנתונים)
- מאפייני ביצועים

### מה ידוע מהקוד:
- סדר רצף האתחול (שורות 259-351)
- התנהגות טיפול באותות (שורות 239-253, 1937-1972)
- מצבי מכונת המצבים (GOING_UP, SYSTEM_UP, GOING_DOWN, SYSTEM_DOWN)
- סט פקודות IPC (LOAD_PAR, STRT_PH_ONLY, STRT_DC_ONLY וכו')
- רצף ניקוי הכיבוי (שורות 1322-1469)

---

*נוצר על ידי סוכן המתעד של CIDRA - DOC-FATHER-001*
