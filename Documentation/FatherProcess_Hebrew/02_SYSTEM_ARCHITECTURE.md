# FatherProcess - ארכיטקטורת מערכת

**רכיב**: FatherProcess
**מזהה משימה**: DOC-FATHER-001
**תאריך יצירה**: 2026-02-02

---

## מודל תהליכים

על פי הקוד ב-`FatherProcess.c:350-351`, FatherProcess רושם את עצמו כ-`FATHERPROC_TYPE` עבור שתי תת-המערכות (`PHARM_SYS | DOCTOR_SYS`), דבר המעיד על כך שהוא משמש כמפקח האב עבור כל מערכת הבריאות של מכבי.

### היררכיית תהליכים

```
                    ┌─────────────────────┐
                    │    FatherProcess    │
                    │  (FATHERPROC_TYPE)  │
                    │   PID: [דינמי]      │
                    └──────────┬──────────┘
                               │
           ┌───────────────────┼───────────────────┐
           │                   │                   │
           ▼                   ▼                   ▼
    ┌─────────────┐     ┌─────────────┐     ┌─────────────┐
    │  SqlServer  │     │As400UnixSrv │     │  תהליכי בן  │
    │(SQLPROC_TYPE)│     │(AS400TOUNIX │     │   אחרים     │
    │             │     │  _TYPE)     │     │             │
    └─────────────┘     └─────────────┘     └─────────────┘
```

### דגלי תת-מערכות

על פי הקוד בשורות 409-445, המערכת קובעת אילו תת-מערכות להפעיל על בסיס משתנה הסביבה `MAC_SYS`:

| דגל | קבוע | משמעות |
|-----|------|--------|
| ביט 0 | PHARM_SYS | תת-מערכת בית מרקחת |
| ביט 1 | DOCTOR_SYS | תת-מערכת רופאים |
| ביט 2 | DOCTOR_SYS_TCP | תת-מערכת TCP רופאים |

כפי שנראה בשורות 418-436, אם `MAC_SYS` לא מוגדר או ריק, המערכת כברירת מחדל מפעילה גם בית מרקחת וגם רופאים (`PHARM_SYS | DOCTOR_SYS`).

---

## רצף אתחול

על בסיס חלק האתחול ב-`FatherProcess.c:210-351`, נראה כי רצף האתחול הוא:

```
┌─────────────────────────────────────────────────────────────────────┐
│                         רצף אתחול                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. fcntl() - שמירת מתארי קבצים 0-2 פתוחים      [שורה 219-224]      │
│        │                                                            │
│        ▼                                                            │
│  2. setsid() - הפיכה למנהיג סשן                 [שורה 227]          │
│        │                                                            │
│        ▼                                                            │
│  3. InitEnv() / HashEnv() - הגדרת סביבה         [שורה 230-233]      │
│        │                                                            │
│        ▼                                                            │
│  4. sigaction(SIGTERM) - התקנת מטפל אותות       [שורה 250-253]      │
│        │                                                            │
│        ▼                                                            │
│  5. SQLMD_connect() - חיבור למסד נתונים (ניסיונות) [שורה 262-271]   │
│        │                                                            │
│        ▼                                                            │
│  6. SqlGetParamsByName() - טעינת פרמטרים        [שורה 277]          │
│        │                                                            │
│        ▼                                                            │
│  7. mlockall()/plock() - נעילת דפים בזיכרון     [שורה 281-291]      │
│        │                                                            │
│        ▼                                                            │
│  8. setuid() - ירידה למשתמש ללא הרשאות          [שורה 294-297]      │
│        │                                                            │
│        ▼                                                            │
│  9. GetCurrNamedPipe() / ListenSocketNamed()    [שורה 300-301]      │
│        │     - יצירת נקודת קצה IPC                                  │
│        ▼                                                            │
│ 10. CreateSemaphore() - סמפור מערכת             [שורה 304]          │
│        │                                                            │
│        ▼                                                            │
│ 11. InitFirstExtent() - אתחול זיכרון משותף      [שורה 307]          │
│        │                                                            │
│        ▼                                                            │
│ 12. לולאת CreateTable - יצירת טבלאות shm        [שורה 312-334]      │
│        │     (איטרציה על TableTab[])                                │
│        ▼                                                            │
│ 13. AddCurrProc() - רישום בטבלת תהליכים         [שורה 351]          │
│        │                                                            │
│        ▼                                                            │
│ 14. sql_dbparam_into_shm() - טעינת פרמטרים ל-shm [שורה 348]         │
│        │                                                            │
│        ▼                                                            │
│ 15. run_system() - הפעלת כל תהליכי הבן          [שורה 445]          │
│        │                                                            │
│        ▼                                                            │
│     [כניסה ללולאת השמירה]                                           │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

## מנגנוני IPC

### 1. סוקטי Unix-Domain (Named Pipes)

על פי הקשר המחקר והקוד בשורות 299-301, המערכת משתמשת בסוקטי Unix-domain (`AF_UNIX`, `SOCK_STREAM`) לתקשורת בין-תהליכית:

**יצירה** (FatherProcess.c:299-301):
```c
GetCurrNamedPipe (CurrNamedPipe);
ABORT_ON_ERR (ListenSocketNamed (CurrNamedPipe));
```

**קבלת הודעות** (FatherProcess.c:1123):
```c
state = GetSocketMessage (500000, buf, sizeof (buf), &len, CLOSE_SOCKET);
```

**פקודות IPC** (שורות 1127-1197):
| פקודה | מטרה |
|-------|------|
| LOAD_PAR | טעינה מחדש של פרמטרים ממסד הנתונים לזיכרון משותף |
| STRT_PH_ONLY | הפעלת מערכת בית המרקחת |
| STRT_DC_ONLY | הפעלת מערכת הרופאים |
| STDN_PH_ONLY | כיבוי מערכת בית המרקחת |
| STDN_DC_ONLY | כיבוי מערכת הרופאים |
| SHUT_DWN | כיבוי מערכת מלא מסודר |
| STDN_IMM | כיבוי מערכת מלא מיידי |

### 2. סמפור

על פי שורה 304, נוצר סמפור מערכת:
```c
ABORT_ON_ERR (CreateSemaphore ());
```

הסמפור נמחק במהלך הכיבוי בשורה 1453:
```c
DeleteSemaphore ();
```

### 3. זיכרון משותף

**אתחול** (שורה 307):
```c
ABORT_ON_ERR (InitFirstExtent (SharedSize));
```

**לולאת יצירת טבלאות** (שורות 312-334):
טבלאות נוצרות על ידי איטרציה על `TableTab[]` (מוגדר ב-GenSql.c).

**ניקוי** (שורה 1447):
```c
KillAllExtents ();
```

---

## טבלאות זיכרון משותף

על בסיס המשתנים הגלובליים בשורות 78-116 ומערך `table_ptrs`, נראה כי הטבלאות הבאות נוצרות:

| שם טבלה | מצביע | סוג שורה | מטרה |
|---------|-------|----------|------|
| PARM_TABLE | parm_tablep | PARM_DATA | פרמטרים ממסד הנתונים |
| PROC_TABLE | proc_tablep | PROC_DATA | רישום תהליכים |
| STAT_TABLE | stat_tablep | STAT_DATA | סטטוס מערכת |
| TSTT_TABLE | tstt_tablep | TSTT_DATA | סטטיסטיקות בית מרקחת |
| DSTT_TABLE | dstt_tablep | DSTT_DATA | סטטיסטיקות רופאים |
| UPDT_TABLE | updt_tablep | UPDT_DATA | חותמות זמן עדכון טבלאות |
| MSG_RECID_TABLE | msg_recid_tablep | MESSAGE_RECID_ROW | מזהי רשומות הודעות |
| PRSC_TABLE | prsc_tablep | PRESCRIPTION_ROW | מרשמים |
| DIPR_TABLE | dipr_tablep | DIPR_DATA | תהליכים שמתו |

---

## זרימת נתונים

### זרימת נתונים בהפעלה

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   מסד נתונים │────▶│ FatherProcess│────▶│    זיכרון    │
│  setup_new   │     │              │     │    משותף    │
└──────────────┘     └──────────────┘     └──────────────┘
       │                    │                    │
       │                    │                    │
       │              ┌─────▼─────┐              │
       │              │  תהליכי   │              │
       │              │    בן    │◀─────────────┘
       │              └───────────┘     (צירוף + קריאה)
       │                    │
       └────────────────────┘
         (גישה ישירה ל-DB)
```

### זרימת בקרה בזמן ריצה

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   בקר        │────▶│ FatherProcess│────▶│   תהליכי    │
│   חיצוני     │     │ (socket IPC) │     │     בן      │
│ (control.exe)│     │              │     │             │
└──────────────┘     └──────────────┘     └──────────────┘
                           │
                           ▼
                    ┌──────────────┐
                    │    זיכרון    │
                    │    משותף    │
                    │ (stat_tablep)│
                    └──────────────┘
```

---

## נקודות אינטגרציה

### מסד נתונים

**חיבור** (שורות 262-271):
- משתמש ב-`SQLMD_connect()` עם לולאת ניסיונות חוזרים עד ש-`MAIN_DB->Connected`
- שינה 10 שניות בין ניסיונות

**סמנים** (מוגדרים ב-MacODBC_MyOperators.c):

| סמן | שאילתה | מטרה |
|-----|--------|------|
| FP_params_cur | SELECT מ-setup_new (לפי program_name) | קבלת פרמטרי תוכנית |
| FP_setup_cur | SELECT הכל מ-setup_new | טעינת כל הפרמטרים לזיכרון משותף |

**ניתוק** (שורה 1441):
```c
SQLMD_disconnect ();
```

### ספריות חיצוניות

על בסיס הצהרות #include ודפוסי קוד:

| ספריה | פונקציות בשימוש | מטרה |
|-------|----------------|------|
| GenLib | InitFirstExtent, CreateTable, Run_server וכו' | זיכרון משותף, הפעלת תהליכים |
| GenSql | SQLMD_connect, סמנים, TableTab[] | גישה למסד נתונים |

---

## מכונת מצבים

על פי שורות 509-661, המערכת מתחזקת מכונת מצבים לעקיבה אחר סטטוס המערכת:

### מצבי מערכת

| מצב | קבוע | משמעות |
|-----|------|--------|
| 0 | GOING_UP | המערכת מתחילה לעלות |
| 1 | SYSTEM_UP | המערכת פועלת |
| 2 | GOING_DOWN | המערכת נכבית |
| 3 | SYSTEM_DOWN | המערכת כבויה לחלוטין |

### מעברי מצבים

```
                 ┌───────────────┐
                 │   GOING_UP    │
                 │   (התחלתי)    │
                 └───────┬───────┘
                         │ sons > 0
                         ▼
                 ┌───────────────┐
          ┌──────│   SYSTEM_UP   │◀────────┐
          │      │    (פועל)     │         │
          │      └───────┬───────┘         │
          │              │                 │
 הפעלת    │              │ פקודת           │ הפעלה
 תת-מערכת │              │ כיבוי           │ מחדש
          │              ▼                 │
          │      ┌───────────────┐         │
          │      │  GOING_DOWN   │─────────┘
          │      │   (נכבה)      │
          │      └───────┬───────┘
          │              │ sons < 1
          │              ▼
          │      ┌───────────────┐
          └─────▶│  SYSTEM_DOWN  │
                 │    (כבוי)     │
                 └───────────────┘
```

### סטטוס לכל תת-מערכת

על פי שורות 603-660, כל תת-מערכת (בית מרקחת, רופאים) מתחזקת סטטוס עצמאי משלה, נפרד מסטטוס המערכת הכללי:
- `stat_data.pharm_status`
- `stat_data.doctor_status`

---

## טיפול באותות

### אותות מטופלים

על פי שורות 250-253 ו-1937-1972:

| אות | מספר | מטפל | פעולה |
|-----|------|------|-------|
| SIGTERM | 15 | TerminateHandler | כיבוי מסודר |
| SIGFPE | - | TerminateHandler | רישום ביומן וכיבוי |
| SIGSEGV | - | TerminateHandler | רישום ביומן וכיבוי |

### התנהגות מטפל האותות

כפי שנראה בשורות 1937-1972, `TerminateHandler()`:
1. מאפס טיפול באותות דרך `sigaction()`
2. מגדיר משתנה גלובלי `caught_signal`
3. רושם הודעה תיאורית ביומן
4. מפעיל כיבוי מסודר של המערכת

---

## רצף כיבוי

על פי שורות 1322-1469:

```
┌─────────────────────────────────────────────────────────────────────┐
│                          רצף כיבוי                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                     │
│  1. לולאה דרך proc_tablep                       [שורה 1348]         │
│        │                                                            │
│        ▼                                                            │
│  2. לכל תהליך בן:                                                   │
│     - SqlServer, As400UnixServer, DocSqlServer,                     │
│       PurchaseHistoryServer: kill(SIGTERM)      [שורה 1372]         │
│     - כל השאר: kill(Signal 9)                   [שורה 1375]         │
│        │                                                            │
│        ▼                                                            │
│  3. הסרת named pipe של הבן                      [שורה 1382-1388]    │
│        │                                                            │
│        ▼                                                            │
│  4. SQLMD_disconnect() - סגירת מסד נתונים       [שורה 1441]         │
│        │                                                            │
│        ▼                                                            │
│  5. DisposeSockets() - סגירת סוקטים             [שורה 1444]         │
│        │                                                            │
│        ▼                                                            │
│  6. KillAllExtents() - הסרת זיכרון משותף        [שורה 1447]         │
│        │                                                            │
│        ▼                                                            │
│  7. usleep(1000000) - המתנת שנייה אחת           [שורה 1452]         │
│        │                                                            │
│        ▼                                                            │
│  8. DeleteSemaphore()                           [שורה 1453]         │
│        │                                                            │
│        ▼                                                            │
│  9. exit(MAC_OK)                                [שורה 1464]         │
│                                                                     │
└─────────────────────────────────────────────────────────────────────┘
```

---

*נוצר על ידי סוכן המתעד של CIDRA - DOC-FATHER-001*
