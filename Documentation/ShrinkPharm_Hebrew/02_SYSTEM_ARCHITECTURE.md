# ShrinkPharm - ארכיטקטורת מערכת

**מזהה מסמך:** DOC-SHRINK-001
**תאריך יצירה:** 2026-02-03
**מקור:** source_code/ShrinkPharm/ (574 שורות מקור מאומתות)

---

## מודל תהליכים

ShrinkPharm פועל כ**כלי אצווה עצמאי**, שונה מתהליכי השרת הפועלים לאורך זמן במערכת הבריאות של מכבי.

### השוואה לתהליכי שרת

| היבט | ShrinkPharm | תהליכי שרת (SqlServer, As400UnixServer) |
|------|-------------|----------------------------------------|
| אתחול | `SQLMD_connect()` ישיר | תבנית `InitSonProcess()` |
| משך חיים | אצווה הרצה-להשלמה | דימון פועל לאורך זמן |
| IPC | אין | סוקטים עם שמות, זיכרון משותף |
| רישום | אין | רישום ב-PROC_TABLE |
| פיקוח | לא מפוקח על ידי FatherProcess | מפוקח ומופעל מחדש אוטומטית |

על פי הקוד ב-`ShrinkPharm.c:128-137`, ShrinkPharm מתחבר למסד הנתונים בלולאת ניסיונות פשוטה ללא שימוש באתחול `InitSonProcess()` שתהליכי שרת משתמשים בו (כפי שנראה ב-`GenLib/Memory.c:552-612`).

### היררכיית תהליכים

```
┌─────────────────────────────────────────────────────────────────┐
│                    הקשר מערכת מכבי                               │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌───────────────────┐                                         │
│   │   FatherProcess   │ ◄─── מפקח שומר                          │
│   │   (לא הורה)       │                                         │
│   └─────────┬─────────┘                                         │
│             │                                                    │
│             │ מפעיל שרתים מפוקחים                                │
│             ▼                                                    │
│   ┌───────────────────┐  ┌───────────────────┐                  │
│   │    SqlServer      │  │  As400UnixServer  │  ...שרתים       │
│   │  (InitSonProcess) │  │  (InitSonProcess) │                  │
│   └───────────────────┘  └───────────────────┘                  │
│                                                                  │
│   ═══════════════════════════════════════════════════════════   │
│                                                                  │
│   ┌───────────────────┐                                         │
│   │    ShrinkPharm    │ ◄─── כלי עצמאי                          │
│   │  (חיבור ישיר)     │     (רץ עצמאית)                         │
│   └─────────┬─────────┘                                         │
│             │                                                    │
│             │ חיבור ODBC ישיר                                   │
│             ▼                                                    │
│   ┌───────────────────┐                                         │
│   │    MS-SQL DB      │                                         │
│   │ (דרך דרייבר ODBC) │                                         │
│   └───────────────────┘                                         │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## זרימת נתונים

### זרימת פעולת מחיקה

```
┌──────────────────────────────────────────────────────────────────┐
│                    זרימת ביצוע ShrinkPharm                        │
├──────────────────────────────────────────────────────────────────┤
│                                                                   │
│  1. הפעלה                                                        │
│     ┌─────────────┐                                              │
│     │   main()    │                                              │
│     │  שורה 35    │                                              │
│     └──────┬──────┘                                              │
│            │                                                      │
│            ▼                                                      │
│  2. חיבור למסד נתונים                                           │
│     ┌─────────────────────────────────────────┐                  │
│     │  לולאת ניסיונות SQLMD_connect()         │                  │
│     │  שורות 128-137                          │                  │
│     │  עד ש-MAIN_DB->Connected                │                  │
│     └──────────────┬──────────────────────────┘                  │
│                    │                                              │
│                    ▼                                              │
│  3. קריאת תצורה                                                  │
│     ┌─────────────────────────────────────────┐                  │
│     │  ShrinkPharmControlCur                  │                  │
│     │  SELECT מ-shrinkpharm                   │                  │
│     │  WHERE purge_enabled <> 0               │                  │
│     │  שורות 147-150                          │                  │
│     └──────────────┬──────────────────────────┘                  │
│                    │                                              │
│                    ▼                                              │
│  4. לכל טבלת יעד:                                                │
│     ┌─────────────────────────────────────────┐                  │
│     │  א. חישוב MinDateToRetain               │ שורה 189        │
│     │     = SysDate - days_to_retain          │                  │
│     │                                          │                  │
│     │  ב. פתיחת ShrinkPharmSelectCur          │ שורה 227        │
│     │     SELECT date_column FROM table       │                  │
│     │                                          │                  │
│     │  ג. לכל שורה:                           │ שורות 236-295   │
│     │     - DELETE WHERE CURRENT OF cursor    │                  │
│     │     - COMMIT כל commit_count שורות      │                  │
│     │                                          │                  │
│     │  ד. שמירת סטטיסטיקות דרך                │ שורות 306-307   │
│     │     ShrinkPharmSaveStatistics           │                  │
│     └──────────────┬──────────────────────────┘                  │
│                    │                                              │
│                    ▼                                              │
│  5. ניקוי ויציאה                                                 │
│     ┌─────────────────────────────────────────┐                  │
│     │  CommitAllWork()                        │ שורה 327        │
│     │  SQLMD_disconnect()                     │ שורה 328        │
│     │  exit(0)                                │ שורה 358        │
│     └─────────────────────────────────────────┘                  │
│                                                                   │
└──────────────────────────────────────────────────────────────────┘
```

---

## אינטראקציה עם מסד נתונים

### אסטרטגיית חיבור

על פי הקוד ב-`ShrinkPharm.c:128-137`:

```
do {
    SQLMD_connect();
    if (!MAIN_DB->Connected) {
        sleep(10);
        // ניסיון חוזר...
    }
} while (!MAIN_DB->Connected);
```

תבנית זו דומה ל-FatherProcess (`FatherProcess.c:259-271`) אך ללא תשתית `InitSonProcess()`.

### תצורת ODBC

כפי שנראה ב-`ShrinkPharm.c:124-126`:

| הגדרה | ערך | מטרה |
|-------|-----|------|
| LOCK_TIMEOUT | 1000 מ"ש | המתנה סבלנית לנעילות |
| DEADLOCK_PRIORITY | -2 | מתחת לרגיל להעדפת פעולות זמן-אמת |
| ODBC_PRESERVE_CURSORS | 1 | שימור סמנים לאחר COMMIT |

על פי הערה ב-`SqlServer.c:299-312`, `ODBC_PRESERVE_CURSORS` "צריך להיות מוגדר TRUE רק לתוכניות פשוטות יחסית כמו ShrinkPharm או As400UnixClient."

### מודל סמנים

```
┌─────────────────────────────────────────────────────────────────┐
│                     יחסי סמנים                                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                  │
│   ┌───────────────────────────────────────┐                     │
│   │  ShrinkPharmCtrlCur (סמן בקרה)        │                     │
│   │  - קורא שורות תצורת shrinkpharm       │                     │
│   │  - סמן עם שם ל-UPDATE CURRENT OF      │                     │
│   └─────────────────┬─────────────────────┘                     │
│                     │                                            │
│                     │ לכל שורת תצורה                             │
│                     ▼                                            │
│   ┌───────────────────────────────────────┐                     │
│   │  ShrinkPharmSelCur (סמן בחירה)        │                     │
│   │  - קורא שורות למחיקה מיעד             │                     │
│   │  - סמן עם שם ל-DELETE CURRENT OF      │                     │
│   └─────────────────┬─────────────────────┘                     │
│                     │                                            │
│                     │ לכל שורה נבחרת                             │
│                     ▼                                            │
│   ┌───────────────────────────────────────┐                     │
│   │  DELETE WHERE CURRENT OF              │                     │
│   │  ShrinkPharmSelCur                    │                     │
│   │  (הצהרה דביקה לביצועים)               │                     │
│   └───────────────────────────────────────┘                     │
│                                                                  │
│   מפתח: ODBC_PRESERVE_CURSORS=1 מאפשר לסמנים לשרוד             │
│        קריאות CommitAllWork()                                    │
│                                                                  │
└─────────────────────────────────────────────────────────────────┘
```

---

## נקודות אינטגרציה

### תשתית משותפת

| רכיב | כיצד ShrinkPharm משתמש בו |
|------|---------------------------|
| GenLib | כלי תאריך/שעה, רישום יומן, טיפול בשגיאות |
| GenSql | שכבת הפשטה ODBC, פעולות סמן |
| MacODBC.h | תשתית קישוריות מסד נתונים |

### טבלאות מסד נתונים

| טבלה | תפקיד | פעולות |
|------|-------|--------|
| shrinkpharm | טבלת בקרה | SELECT (קריאת תצורה), UPDATE (כתיבת סטטיסטיקות) |
| (דינמי) | טבלאות יעד | SELECT (קריאת שורות), DELETE (מחיקת שורות) |

**הערת אבטחה:** שמות טבלאות יעד ושמות עמודות תאריך נקראים מטבלת הבקרה `shrinkpharm` ומשובצים ב-SQL דינמי. אם טבלת הבקרה אינה מנוהלת כראוי, זה יכול לאפשר מחיקת נתונים לא מכוונת.

---

## טיפול באותות

על פי הקוד ב-`ShrinkPharm.c:100-116` ו-`ShrinkPharm.c:370-430`:

### מטפלי אותות מותקנים

| אות | מטפל | פעולה |
|-----|------|-------|
| SIGFPE | TerminateHandler | RollbackAllWork, רישום, יציאה |
| SIGSEGV | (מסומן כהערה) | היה מטפל בשגיאת סגמנטציה |
| SIGTERM | (לא מותקן) | היה מטפל בבקשת סיום |

### התנהגות TerminateHandler (שורות 370-430)

1. איפוס טיפול באותות דרך sigaction
2. זיהוי לולאות אינסופיות (אותו אות באותו זמן)
3. עבור SIGFPE/SIGSEGV: קריאה ל-RollbackAllWork()
4. רישום הודעה תיאורית ביומן
5. קריאה ל-SQLMD_disconnect() ו-ExitSonProcess()

---

## תלויות סביבה

### משתני סביבה נדרשים

| משתנה | מטרה | משמש ב |
|-------|------|--------|
| MAC_LOG | ספריית קבצי יומן | `ShrinkPharm.c:72` |
| MS_SQL_ODBC_DSN | שם מקור נתוני ODBC | דרך GenSql |
| MS_SQL_ODBC_USER | שם משתמש מסד נתונים | דרך GenSql |
| MS_SQL_ODBC_PASS | סיסמת מסד נתונים | דרך GenSql |
| MS_SQL_ODBC_DB | שם מסד נתונים | דרך GenSql |

**הערה:** על פי הקוד ב-`ShrinkPharm.c:72`, `getenv("MAC_LOG")` משמש ללא בדיקת NULL, מה שעלול לגרום לקריסה אם המשתנה לא מוגדר.

---

## תצורת בנייה

על פי `Makefile:1-26`:

### יעדי בנייה

| יעד | פקודה |
|-----|-------|
| all | בניית ShrinkPharm.exe |
| clean | הסרת TARGET ו-OBJS |

### הידור

```makefile
TARGET = ShrinkPharm.exe
SRCS   = ShrinkPharm.c
OBJS   = ShrinkPharm.o
LIBS   = -lodbc -D_GNU_SOURCE
```

ה-Makefile כולל הגדרות משותפות מ-`../Util/Defines.mak` וכללים מ-`../Util/Rules.mak`.

---

*מסמך נוצר על ידי סוכן המתעד של CIDRA*
*מזהה משימה: DOC-SHRINK-001*
