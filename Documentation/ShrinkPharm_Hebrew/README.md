# ShrinkPharm

**רכיב:** כלי תחזוקת מסד נתונים
**מערכת:** מערכת בריאות מכבי - Backend ב-C
**גרסת תיעוד:** DOC-SHRINK-001
**תאריך יצירה:** 2026-02-03

---

## סיכום מהיר

ShrinkPharm הוא כלי תחזוקת מסד נתונים עצמאי שמוחק נתונים היסטוריים ממסד הנתונים של בית המרקחת MS-SQL. על פי כותרת קוד המקור (`ShrinkPharm.c:7-10`), הוא מתואר כ-"מקבילה ל-ShrinkDoctor מבוססת ODBC."

התוכנית קוראת תצורת מחיקה מטבלת בקרה (`shrinkpharm`), ואז מוחקת שורות מטבלאות יעד על בסיס מדיניות שמירת נתונים לפי תאריך. היא פועלת עם עדיפות deadlock מתחת לרגיל כדי להימנע משיבוש פעולות זמן-אמת, ומבצעת commit למחיקות באצוות ניתנות להגדרה.

**מאפיינים מרכזיים:**
- כלי אצווה עצמאי (לא תהליך שרת מפוקח)
- מונע תצורה דרך טבלת בקרה במסד נתונים
- מודל commit באצוות לפעולות מחיקה גדולות
- עדיפות מתחת לרגיל לתחרות במסד נתונים

---

## קבצים מרכזיים

| קובץ | שורות | מטרה |
|------|------:|------|
| ShrinkPharm.c | 431 | תוכנית ראשית עם לוגיקת מחיקה |
| MacODBC_MyOperators.c | 133 | הגדרות אופרטורי SQL (5 אופרטורים) |
| MacODBC_MyCustomWhereClauses.c | 10 | מקום שמור לפסוקיות WHERE מותאמות |
| Makefile | 26 | תצורת בנייה ל-Unix |
| **סה"כ** | **600** | (574 מקור + 26 בנייה) |

---

## כיצד להשתמש בתיעוד זה

### מדריך קבצים

| מסמך | תוכן |
|------|------|
| [01_PROGRAM_SPECIFICATION.md](01_PROGRAM_SPECIFICATION.md) | סקירה, מבנה קבצים, פונקציות, תלויות |
| [02_SYSTEM_ARCHITECTURE.md](02_SYSTEM_ARCHITECTURE.md) | מודל תהליכים, זרימת נתונים, נקודות אינטגרציה |
| [03_TECHNICAL_ANALYSIS.md](03_TECHNICAL_ANALYSIS.md) | ניתוח פונקציות, אופרטורי SQL, טיפול בשגיאות |
| [04_BUSINESS_LOGIC.md](04_BUSINESS_LOGIC.md) | אלגוריתם מחיקה, מודל תצורה, התנהגות תפעולית |
| [05_CODE_ARTIFACTS.md](05_CODE_ARTIFACTS.md) | קטעי קוד מרכזיים עם הפניות שורה |
| [VALIDATION_REPORT.md](VALIDATION_REPORT.md) | אימות איכות והסמכה |

### סדר קריאה

1. **התמצאות מהירה:** קרא README זה
2. **סקירה טכנית:** 01_PROGRAM_SPECIFICATION.md
3. **הקשר מערכת:** 02_SYSTEM_ARCHITECTURE.md
4. **צלילה עמוקה:** 03_TECHNICAL_ANALYSIS.md + 04_BUSINESS_LOGIC.md
5. **הפניית קוד:** 05_CODE_ARTIFACTS.md
6. **בדיקת איכות:** VALIDATION_REPORT.md

---

## סיכום אלגוריתם מחיקה

על בסיס ניתוח קוד:

1. חיבור למסד נתונים (ODBC, ניסיון חוזר עד לחיבור)
2. קריאת תצורות מופעלות מטבלת `shrinkpharm`
3. לכל טבלת יעד:
   - חישוב חיתוך: `MinDateToRetain = SysDate - days_to_retain`
   - בחירת שורות שבהן עמודת תאריך < MinDateToRetain
   - מחיקת שורות באמצעות `WHERE CURRENT OF` cursor
   - Commit כל `commit_count` מחיקות
   - תיעוד סטטיסטיקות בחזרה לטבלת בקרה
4. רישום סיכומים ויציאה

---

## תצורה

### הגדרות מסד נתונים (ShrinkPharm.c:124-126)

| פרמטר | ערך | מטרה |
|-------|-----|------|
| LOCK_TIMEOUT | 1000 מ"ש | המתנה סבלנית לנעילות |
| DEADLOCK_PRIORITY | -2 | ויתור לפעולות זמן-אמת |
| ODBC_PRESERVE_CURSORS | 1 | שמירת סמנים פתוחים לאורך commit-ים |

### משתני סביבה

| משתנה | מטרה |
|-------|------|
| MAC_LOG | ספריית קבצי יומן |
| MS_SQL_ODBC_DSN | שם מקור נתוני ODBC |
| MS_SQL_ODBC_USER | שם משתמש מסד נתונים |
| MS_SQL_ODBC_PASS | סיסמת מסד נתונים |
| MS_SQL_ODBC_DB | שם מסד נתונים |

---

## רכיבים קשורים

| רכיב | קשר |
|------|-----|
| [FatherProcess](../FatherProcess_Hebrew/) | משתמש באותו דפוס SQLMD_connect() עם ניסיונות חוזרים; לא מפקח על ShrinkPharm |
| SqlServer | הערות מפנות ל-ShrinkPharm כמתאים ל-ODBC_PRESERVE_CURSORS |
| GenLib | מספק כלי תאריך/שעה, רישום |
| GenSql | מספק שכבת הפשטה ODBC |

---

## בעיות ידועות

על בסיס ניתוח קוד:

1. **ארטיפקט העתק-הדבק:** TerminateHandler רושם ביומן "As400UnixServer" במקום "ShrinkPharm" (`ShrinkPharm.c:388-390, 426-429`)

2. **משתנים גלובליים לא בשימוש:** שלושה משתנים מוצהרים אך לא בשימוש: `need_rollback`, `recs_to_commit`, `recs_committed` (`ShrinkPharm.c:30-32`)

3. **סיכון מצביע NULL:** `getenv("MAC_LOG")` משמש ללא בדיקת NULL (`ShrinkPharm.c:72`)

4. **SQL דינמי:** שמות טבלאות מטבלת בקרה משובצים ב-SQL ללא אימות - תיעוד סיכון בלבד

---

## הוראות בנייה

על פי Makefile:

```bash
# בנייה
make all

# ניקוי
make clean
```

**יעד:** ShrinkPharm.exe
**ספריות:** -lodbc
**הגדרות:** _GNU_SOURCE

---

## מגבלות תיעוד

### מה לא ניתן לקבוע מהקוד:

- סכמה מדויקת של טבלת הבקרה `shrinkpharm` (DDL)
- אילו טבלאות מוגדרות למחיקה בייצור
- כיצד ומתי ShrinkPharm מתוזמן לרוץ
- הצדקה עסקית למדיניות שמירה

### מה ידוע מהקוד:

- אלגוריתם המחיקה ומודל התצורה
- דפוסי חיבור וטיפול בשגיאות
- התנהגות commit באצוות ותיעוד סטטיסטיקות
- הגדרות עדיפות לתחרות במסד נתונים

---

*תיעוד נוצר על ידי סוכן המתעד של CIDRA*
*מזהה משימה: DOC-SHRINK-001*
